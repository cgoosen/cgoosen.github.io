<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Category: PowerShell | Chris&#39;s Blog &mdash; It&#39;s called thinking...  go with it! </title>
    <meta property="og:title" content="Category: PowerShell | Chris&#39;s Blog &mdash; It&#39;s called thinking...  go with it! " />
    <meta name="twitter:title" content="Category: PowerShell | Chris&#39;s Blog &mdash; It&#39;s called thinking...  go with it! " />

    <meta name="description" content="Category: PowerShell">
    <meta name="description" property="og:description" content="Category: PowerShell" />
    <meta name="twitter:description" content="Category: PowerShell" />

    <meta name="twitter:card" content="summary_large_image" />
    
    <meta name="twitter:site" content="@chrisgoosen" />
    
    <meta property="og:url" content="http://172.16.7.177:4000/categories/PowerShell/" />

    <meta property="og:image" content="" />
    <meta name="twitter:image" content="" />

    <meta name="author" content="Chris's Blog" />

    <meta name="copyright" content="Copyright by Chris's Blog. All Rights Reserved." />

    <style>
        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 300;
            src: local('Roboto Light'), local('Roboto-Light'), url(https://fonts.gstatic.com/s/roboto/v15/Hgo13k-tfSpn0qi1SFdUfVtXRa8TVwTICgirnJhmVJw.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 400;
            src: local('Roboto'), local('Roboto-Regular'), url(https://fonts.gstatic.com/s/roboto/v15/CWB0XYA8bzo0kSThX0UTuA.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 700;
            src: local('Roboto Bold'), local('Roboto-Bold'), url(https://fonts.gstatic.com/s/roboto/v15/d-6IYplOFocCacKzxwXSOFtXRa8TVwTICgirnJhmVJw.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 900;
            src: local('Roboto Black'), local('Roboto-Black'), url(https://fonts.gstatic.com/s/roboto/v15/mnpfi9pxYH-Go5UiibESIltXRa8TVwTICgirnJhmVJw.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: italic;
            font-weight: 300;
            src: local('Roboto Light Italic'), local('Roboto-LightItalic'), url(https://fonts.gstatic.com/s/roboto/v15/7m8l7TlFO-S3VkhHuR0at44P5ICox8Kq3LLUNMylGO4.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: italic;
            font-weight: 400;
            src: local('Roboto Italic'), local('Roboto-Italic'), url(https://fonts.gstatic.com/s/roboto/v15/vPcynSL0qHq_6dX7lKVByfesZW2xOQ-xsNqO47m55DA.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: italic;
            font-weight: 700;
            src: local('Roboto Bold Italic'), local('Roboto-BoldItalic'), url(https://fonts.gstatic.com/s/roboto/v15/t6Nd4cfPRhZP44Q5QAjcC44P5ICox8Kq3LLUNMylGO4.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: italic;
            font-weight: 900;
            src: local('Roboto Black Italic'), local('Roboto-BlackItalic'), url(https://fonts.gstatic.com/s/roboto/v15/bmC0pGMXrhphrZJmniIZpY4P5ICox8Kq3LLUNMylGO4.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }
    </style>
    
    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon" />
    
    <link rel="stylesheet" href="http://172.16.7.177:4000/assets/css/main.css">

    <link rel="canonical" href="http://172.16.7.177:4000/categories/PowerShell/">

    <link rel="alternate" type="application/rss+xml" title="" href="http://172.16.7.177:4000/feed.xml">
</head>

    <body>
        <div class="wrapper">
            <aside class="user-profile fixed" role="complementary">
    <div class="burger">
        <input class="trigger hidden" id="toggleBurger" type="checkbox" />
        <label for="toggleBurger">
            <span>Navigation</span>
        </label>
    </div>

    <div class="compact-header">
        <a class="avatar" href="http://172.16.7.177:4000"><img alt="Avatar" src="/assets/img/headshot.jpg" /></a>
        <div class="my-info">
            <strong class="my-name">Chris's Blog</strong>
            <span class="my-job-title">It's called thinking...  go with it!</span>
        </div>
    </div>

    
        
        <div class="mainmenu">
            <a href="http://172.16.7.177:4000" >Home</a>
            
                
            
                
            
                
                    <a href="http://172.16.7.177:4000/contact/" >Contact</a>
                
            
                
                    <a href="http://172.16.7.177:4000/about/" >About</a>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
        </div>
        
    
    
    <div>
    	<img src="/assets/img/mvp.png" style="width:181px;height:74px;">
    </div>

    <p class="about-me"> </p>
    
    <ul class="socials">
        <li><a href="https://twitter.com/chrisgoosen" target="_blank"><svg title="twitter" width="16" height="16" ><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#twitter-icon"></use></svg></a></li><li><a href="https://www.linkedin.com/in/ctgoosen/" target="_blank"><svg title="linkedin" width="16" height="16" ><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#linkedin-icon"></use></svg></a></li><li><a href="https://github.com/cgoosen" target="_blank"><svg title="github" width="16" height="16" ><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#github-icon"></use></svg></a></li>

        
            <li><a href="/contact" target="_blank"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#email-icon"></use></svg></a></li>
        

        
         <li><a href="http://feeds.cgoosen.com/cgoosen"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#rss-icon"></use></svg></a></li>
        
    </ul>
</aside>


            <main class="the-content" role="main">
                <div class="search" role="search">
    <div>
        <div class="show-results-count">0 Results</div>
        <div class="search-holder">
            <input type="text" id="search-input" placeholder="search for..." />
        </div>
    </div>
    <ul id="results-container" class="results-container"></ul>
</div>


                <h1>Posts From Category: PowerShell</h1>


<article class="post" role="article" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="post-header">
        <ul>
            <li><time datetime="2019-02-27T08:38:26-06:00" itemprop="datePublished">27 Feb, 2019</time></li>
            
        </ul>
        <h2 itemprop="name headline"><a href="http://172.16.7.177:4000/2019/02/connect-365-script-updates">Connect-365 Script Updates</a></h2>
    </header>

    <div class="post-content">
        <p>I'm excited to publish a new version of my Connect-365.ps1 script. The new version includes a bunch of usability improvements, the addition of Teams and Azure modules and now supports MFA.</p>
<p><a href="/assets/img/2019/02/Screen-Shot-2019-02-27-at-2.09.37-PM.png"><img src="/assets/img/2019/02/Screen-Shot-2019-02-27-at-2.09.37-PM.png" style="width:539px;height:415;"/></a></p>
<p style="text-align: left;">I have published a code-signed version to the TechNet Gallery, <a href="http://cgoo.se/1srvTiS" target="_blank" rel="noopener">it can be downloaded by clicking here&hellip;</a>&nbsp;or you can<a href="https://github.com/cgoosen/Connect-365" target="_blank" rel="noopener"> grab the code from Github here.&nbsp;</a><a href="https://www.cgoosen.com/wp-content/uploads/2019/02/Screen-Shot-2019-02-27-at-2.09.37-PM.png"><br />
</a></p>


        
    </div>

    <footer class="post-footer">
        <div class="share">Share
            <ul class="social-networks">
                <li class="share-facebook"><a href="https://www.facebook.com/sharer.php?s=100&p[title]=Connect-365 Script Updates&p[summary]=I'm excited to publish a new version of my Connect-365.ps1 script. The new version includes a bunch of usability improvements, the additi...&p[url]=http://172.16.7.177:4000/2019/02/connect-365-script-updates" class="s_facebook" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#facebook-icon"></use></svg></a></a></li>
                <li class="share-twitter"><a href="http://twitter.com/share?url=http://172.16.7.177:4000/2019/02/connect-365-script-updates&text=I'm excited to publish a new version of my Connect-365.ps1 script. The new version includes a bunch of usability improvements, the additi...&hashtags=" rel="noreferrer" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#twitter-icon"></use></svg></a></li>
            </ul>
        </div>
        
        <div class="tags">
            <ul>
                
            </ul>
        </div>
        
    </footer>
</article>

<article class="post" role="article" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="post-header">
        <ul>
            <li><time datetime="2018-02-27T14:00:12-06:00" itemprop="datePublished">27 Feb, 2018</time></li>
            
        </ul>
        <h2 itemprop="name headline"><a href="http://172.16.7.177:4000/2018/02/fun-with-azure-automation-and-table-service-rest-api">Fun with Azure Automation and Table Service REST API</a></h2>
    </header>

    <div class="post-content">
        <p>I love PowerShell and I really love to automate things! I recently started looking into leveraging Azure services for some automation tasks&nbsp;and discovered how powerful it could be. I also had a lot of fun doing it and wanted to share some of what I learned.</p>
<p>Azure&nbsp;Automation is for scheduling tasks or scripts that run on some sort of schedule and is especially useful for any automation you might be doing with Office 365. Your code is stored in a Runbook (PowerShell or Python) and executed according to a schedule. Interacting with modules is a little different to working with your local PowerShell installation, however the <a href="https://docs.microsoft.com/en-us/azure/automation/automation-runbook-gallery" target="_blank" rel="noopener noreferrer">module gallery makes it pretty simple</a>. Getting started is simple, let's assume in this example we will be automating a report in Exchange Online. First you create an Automation Account:</p>
<p><a href="/assets/img/2018/02/auto1.png"><img src="/assets/img/2018/02/auto1.png" style="width:145px;height:300px;" /></a></p>
<p><a href="/assets/img/2018/02/auto2.png"><img src="/assets/img/2018/02/auto2.png" style="width:300px;height:222px;" /></a></p>
<p>Create a credential set for your Exchange Online credentials - remember what you call it.&nbsp;"TenantCreds" in my case.</p>
<p><a href="/assets/img/2018/02/auto4.png"><img src="/assets/img/2018/02/auto4.png" style="width:300px;height:176px;" /></a></p>
<p>Then create a new Runbook:</p>
<p><a href="/assets/img/2018/02/auto3.png"><img src="/assets/img/2018/02/auto3.png" style="width:300px;height:185px;" /></a></p>
<p>Next it's time to add some PowerShell to the Runbook. Since we will be working in Exchange Online, we need to create and import that session. This is similar to working with Exchange Online sessions on your local machine, but you will notice that we don't need to include the credentials in the code and simply reference the credential set we created earlier:</p>
<p><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="o">&lt;</span><span class="n">br</span> <span class="sr">/&gt;
$UserCredential = Get-AutomationPSCredential -Name "TenantCreds"&lt;br /</span><span class="o">&gt;</span>
<span class="vg">$Session</span> <span class="o">=</span> <span class="no">New</span><span class="o">-</span><span class="no">PSSession</span> <span class="o">-</span><span class="no">ConfigurationName</span> <span class="no">Microsoft</span><span class="o">.</span><span class="no">Exchange</span> <span class="o">-</span><span class="no">ConnectionUri</span> <span class="n">https</span><span class="ss">:/</span><span class="o">/</span><span class="n">outlook</span><span class="p">.</span><span class="nf">office365</span><span class="p">.</span><span class="nf">com</span><span class="o">/</span><span class="n">powershell</span><span class="o">-</span><span class="n">liveid</span><span class="o">/</span> <span class="o">-</span><span class="no">Credential</span> <span class="vg">$UserCredential</span> <span class="o">-</span><span class="no">Authentication</span> <span class="no">Basic</span> <span class="o">-</span><span class="no">AllowRedirection</span><span class="o">&lt;</span><span class="n">br</span> <span class="sr">/&gt;
$Commands = @("Get-MigrationBatch","Get-MigrationUser","Get-MigrationUserStatistics","Get-MoveRequestStatistics","Get-MoveRequest")&lt;br /</span><span class="o">&gt;</span>
<span class="no">Import</span><span class="o">-</span><span class="no">PSSession</span> <span class="o">-</span><span class="no">Session</span> <span class="vg">$Session</span> <span class="o">-</span><span class="no">Prefix</span> <span class="s2">"EXO"</span> <span class="o">-</span><span class="no">DisableNameChecking</span><span class="p">:</span><span class="vg">$true</span> <span class="o">-</span><span class="no">AllowClobber</span><span class="p">:</span><span class="vg">$true</span> <span class="o">-</span><span class="no">CommandName</span> <span class="vg">$Commands</span> <span class="o">|</span> <span class="no">Out</span><span class="o">-</span><span class="no">Null</span><span class="o">&lt;</span><span class="n">br</span> <span class="sr">/&gt;</span></pre></td></tr></tbody></table></code></pre></figure></p>
<p>I had some errors when trying to import all Exchange Online cmdlets, so I limit it&nbsp;to only the cmdlets I intend to use in the script. I also add a prefix of "EXO" to these, so these cmdlets are used as follows:</p>
<p><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="o">&lt;</span><span class="n">br</span> <span class="sr">/&gt;
$MigBatch = Get-EXOMigrationBatch | Where-Object {$_.Identity -like '*MyMigration*'} | foreach {$_.BatchGuid}&lt;br /</span><span class="o">&gt;</span></pre></td></tr></tbody></table></code></pre></figure></p>
<p>Lastly, we need to create a schedule for the automation job:</p>
<p><a href="/assets/img/2018/02/schedule1.png"><img src="/assets/img/2018/02/schedule1.png" style="width:300px;height:146px;" /></a></p>
<p>Once the schedule has been created, you can link it to the Runbook:</p>
<p><a href="/assets/img/2018/02/schedule2.png"><img src="/assets/img/2018/02/schedule2.png" style="width:300px;height:142px;" /></a></p>
<p>This is great if you need to perform tasks that don't generate any output. What happens when something (e.g .CSV file) is generated? There are a couple of ways to deal with that. You could just use the temp folder to store your data and <a href="http://www.cgoosen.com/2015/04/user-powershell-to-bulk-email-your-users/" target="_blank" rel="noopener noreferrer">then email it to yourself</a> - remember, data stored in the temp folder will not persist:</p>
<p><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="o">&lt;</span><span class="n">br</span> <span class="sr">/&gt;
$TmpPath = $env:TEMP&lt;br /</span><span class="o">&gt;</span></pre></td></tr></tbody></table></code></pre></figure></p>
<p>Another way to deal with this data is to write it to Azure Storage. There is a <a href="https://docs.microsoft.com/en-us/azure/storage/common/storage-powershell-guide-full" target="_blank" rel="noopener noreferrer">PowerShell module available</a> for Azure Storage that can be used with Azure Automation, but you can also use the APIs. Since&nbsp;I figured out how to use the API, it has become my go to method because it is actually much faster. I have also been able to use it in environments where it isn't possible to install modules.</p>
<p>The first thing we need to do is create a Storage Account in Azure:</p>
<p><a href="/assets/img/2018/02/storage1.png"><img src="/assets/img/2018/02/storage1.png" style="width:138px;height:300px;" /></a></p>
<p>We then create a Shared Access Signature (SAS) for that Storage Account:</p>
<p><a href="/assets/img/2018/02/storage2.png"><img src="/assets/img/2018/02/storage1.png" style="width:300px;height:218px;" /></a></p>
<p>The result should look similar to this:</p>
<p><a href="/assets/img/2018/02/storage3.png"><img src="/assets/img/2018/02/storage1.png" style="width:300px;height:142px;" /></a></p>
<p>In this example, we are going to store our script output in the Table Service, so we'll be using the&nbsp;Table Service REST API. When working with the Table Service it is <a href="https://docs.microsoft.com/en-us/rest/api/storageservices/understanding-the-table-service-data-model" target="_blank" rel="noopener noreferrer">important to understand tables, entities, system properties and other limitations</a>, but for the&nbsp;purposes of this post I'm going to simplify things a little.&nbsp;Tables store data as collections of entities - entities are similar to rows&nbsp;and have&nbsp;a primary key and a set of properties. A property is similar to a column.</p>
<p>Each entity always has the following system properties:</p>
<ul>
<li>PartitionKey</li>
<li>RowKey</li>
<li>Timestamp</li>
</ul>
<p>Timestamp is managed automatically and isn't something you can change. The&nbsp;PartitionKey and RowKey are always required and are used for scalability and indexing of the content so it is important to consider these when designing your table. <a href="https://docs.microsoft.com/en-us/rest/api/storageservices/designing-a-scalable-partitioning-strategy-for-azure-table-storage" target="_blank" rel="noopener noreferrer">Here is some really good information to read up on.</a>&nbsp;In this&nbsp;example, I'll looking up migration status of a mailbox in Exchange Online and will be inserting this data into a table. I'm going to use the "BatchID" as the&nbsp;PartitionKey and the "Status" as the&nbsp;RowKey. The table name in the example will use the "Alias" of the mailbox.</p>
<p>First, lets define the data we are going to insert. This could easily be used in a script or automation Runbook as a Foreach() loop, but to keep it simple I'm just going to manually define them in the example</p>
<p><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="o">&lt;</span><span class="n">br</span> <span class="sr">/&gt;
$UserTable = "ZacTurner"&lt;br /</span><span class="o">&gt;</span>
<span class="vg">$PartitionKey</span> <span class="o">=</span> <span class="s2">"Batch02"</span><span class="o">&lt;</span><span class="n">br</span> <span class="sr">/&gt;
$RowKey = "Synced"&lt;br /</span><span class="o">&gt;</span>
<span class="vg">$PrimaryEmailAddress</span> <span class="o">=</span> <span class="s2">"ZacTurner@o365testlab.com"</span><span class="o">&lt;</span><span class="n">br</span> <span class="sr">/&gt;
$MbxGuid = "e31949b2-ebc6-4f57-b9ae-0aa8ae73bb2c"&lt;br /</span><span class="o">&gt;</span>
<span class="vg">$Batch</span> <span class="o">=</span> <span class="s2">"Batch02"</span><span class="o">&lt;</span><span class="n">br</span> <span class="sr">/&gt;
$Status = "Synced"&lt;br /</span><span class="o">&gt;</span>
<span class="vg">$Skipped</span> <span class="o">=</span> <span class="s2">"4"</span><span class="o">&lt;</span><span class="n">br</span> <span class="sr">/&gt;
$LastCheck = "2/</span><span class="mi">27</span><span class="o">/</span><span class="mi">2018</span> <span class="mi">8</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mo">01</span> <span class="no">PM</span><span class="s2">"&lt;br /&gt;</span></pre></td></tr></tbody></table></code></pre></figure></p>
<p>Next we will import this information, during the import, we'll first check to see if a unique table already exists (using the Alias). If one does exist, we'll insert the data, if one doesn't exist we will create it.</p>
<p><figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="code"><pre><span class="o">&lt;</span><span class="n">br</span> <span class="sr">/&gt;
$AzureEndpoint = 'https:/</span><span class="o">/</span><span class="n">cgblogpostdemo</span><span class="p">.</span><span class="nf">table</span><span class="p">.</span><span class="nf">core</span><span class="p">.</span><span class="nf">windows</span><span class="p">.</span><span class="nf">net</span><span class="o">/</span><span class="s1">'&lt;br /&gt;
$AzureSAS = "?sv=2017-07-29&amp;amp;ss=bfqt&amp;amp;srt=sco&amp;amp;sp=rwdlacup&amp;amp;se=2018-04-05T02:31:38Z&amp;amp;st=2018-02-27T19:31:38Z&amp;amp;spr=https&amp;amp;sig=&lt;removed&gt;"&lt;br /&gt;
$AzureRequestHeaders = @{&lt;br /&gt;
		"x-ms-date"=(Get-Date -Format r);&lt;br /&gt;
		"x-ms-version"="2016-05-31";&lt;br /&gt;
		"Accept-Charset"="UTF-8";&lt;br /&gt;
		"DataServiceVersion"="3.0;NetFx";&lt;br /&gt;
		"MaxDataServiceVersion"="3.0;NetFx";&lt;br /&gt;
		"Accept"="application/json;odata=nometadata"}&lt;/p&gt;
&lt;p&gt;$UserURI = $AzureEndpoint + $UserTable + "/" + $AzureSAS&lt;/p&gt;
&lt;p&gt;#Check if table already exists&lt;br /&gt;
$UserTableExists = Invoke-WebRequest -Method GET -Uri $UserURI -Headers $AzureRequestHeaders&lt;br /&gt;
$UserTableExists = $UserTableExists.StatusCode&lt;/p&gt;
&lt;p&gt;If ($UserTableExists -ne "200"){&lt;br /&gt;
		 $TableRequestBody = ConvertTo-Json -InputObject @{&lt;br /&gt;
							"TableName"=$UserTable}&lt;br /&gt;
		 $EncodedTableRequestBody = [System.Text.Encoding]::UTF8.GetBytes($TableRequestBody)&lt;br /&gt;
		 $TableURI = $AzureEndpoint + '</span><span class="no">Tables</span><span class="o">/</span><span class="err">'</span> <span class="o">+</span> <span class="vg">$AzureSAS</span><span class="o">&lt;</span><span class="n">br</span> <span class="sr">/&gt;
		Invoke-WebRequest -Method POST -Uri $TableURI -Headers $AzureRequestHeaders -Body $EncodedTableRequestBody -ContentType "application/</span><span class="n">json</span><span class="s2">"&lt;br /&gt;
			}&lt;/p&gt;
&lt;p&gt;#Insert data&lt;br /&gt;
$AzureRequestBody = ConvertTo-Json -InputObject @{&lt;br /&gt;
		"</span><span class="no">PartitionKey</span><span class="s2">"= "</span><span class="vg">$PartitionKey</span><span class="s2">";&lt;br /&gt;
		"</span><span class="no">RowKey</span><span class="s2">"= "</span><span class="vg">$RowKey</span><span class="s2">";&lt;br /&gt;
		"</span><span class="no">PrimaryEmailAddress</span><span class="s2">"= "</span><span class="vg">$PrimaryEmailAddress</span><span class="s2">";&lt;br /&gt;
		"</span><span class="no">MbxGuid</span><span class="s2">"= "</span><span class="vg">$MbxGuid</span><span class="s2">";&lt;br /&gt;
		"</span><span class="no">BatchName</span><span class="s2">"= "</span><span class="vg">$Batch</span><span class="s2">";&lt;br /&gt;
		"</span><span class="no">Status</span><span class="s2">"= "</span><span class="vg">$Status</span><span class="s2">";&lt;br /&gt;
		"</span><span class="no">ItemsSkipped</span><span class="s2">"= "</span><span class="vg">$Skipped</span><span class="s2">";&lt;br /&gt;
		"</span><span class="no">LastCheck</span><span class="s2">"= "</span><span class="vg">$LastCheck</span><span class="s2">"}&lt;br /&gt;
$EncodedAzureRequestBody = [System.Text.Encoding]::UTF8.GetBytes($AzureRequestBody)&lt;br /&gt;
Invoke-WebRequest -Method POST -Uri $UserURI -Headers $AzureRequestHeaders -Body $EncodedAzureRequestBody -ContentType "</span><span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="s2">"&lt;br /&gt;</span></pre></td></tr></tbody></table></code></pre></figure></p>
<p>You could also use <a href="https://docs.microsoft.com/en-us/powershell/module/Microsoft.PowerShell.Utility/Invoke-RestMethod?view=powershell-5.1" target="_blank" rel="noopener noreferrer">Invoke-RestMethod</a> instead of Invoke-WebRequest. The resulting tables should look like this:</p>
<p><a href="/assets/img/2018/02/storage4-1.png"><img src="/assets/img/2018/02/storage4-1.png" style="width:300px;height:144px;" /></a></p>
<p style="text-align: left;">Credit to&nbsp;a couple of Stack Overflow posts that were really helpful&nbsp;when I was trying to figure this out:</p>
<ul>
<li style="text-align: left;"><a href="https://stackoverflow.com/questions/42792430/adding-azure-table-entity-with-powershell-with-rest-api" target="_blank" rel="noopener noreferrer">Here</a></li>
<li style="text-align: left;"><a href="https://stackoverflow.com/questions/47214227/powershell-invoke-restmethod-error-415-unsupported-media-type" target="_blank" rel="noopener noreferrer">Here</a></li>
</ul>



        
            <p><a href="/2018/02/fun-with-azure-automation-and-table-service-rest-api" role="button">Read More</a></p>
        
    </div>

    <footer class="post-footer">
        <div class="share">Share
            <ul class="social-networks">
                <li class="share-facebook"><a href="https://www.facebook.com/sharer.php?s=100&p[title]=Fun with Azure Automation and Table Service REST API&p[summary]=I love PowerShell and I really love to automate things! I recently started looking into leveraging Azure services for some automation tas...&p[url]=http://172.16.7.177:4000/2018/02/fun-with-azure-automation-and-table-service-rest-api" class="s_facebook" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#facebook-icon"></use></svg></a></a></li>
                <li class="share-twitter"><a href="http://twitter.com/share?url=http://172.16.7.177:4000/2018/02/fun-with-azure-automation-and-table-service-rest-api&text=I love PowerShell and I really love to automate things! I recently started looking into leveraging Azure services for some automation tas...&hashtags=" rel="noreferrer" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#twitter-icon"></use></svg></a></li>
            </ul>
        </div>
        
        <div class="tags">
            <ul>
                
            </ul>
        </div>
        
    </footer>
</article>

<article class="post" role="article" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="post-header">
        <ul>
            <li><time datetime="2018-01-30T09:21:49-06:00" itemprop="datePublished">30 Jan, 2018</time></li>
            
        </ul>
        <h2 itemprop="name headline"><a href="http://172.16.7.177:4000/2018/01/my-powershell-scripts-are-now-available-on-github">My PowerShell scripts are now available on GitHub</a></h2>
    </header>

    <div class="post-content">
        <p>Ever since I first started sharing scripts on my blog, I've had a bunch of people reach out to me with stories of how they've used my code in their projects or offering to collaborate with me on future versions. My intention has always been to make my scripts easily downloadable and ready to run - one of the reasons why I sign the code with a code signing certificate, but I've come to realize that there is no reason why I couldn't do both.</p>
<p>Over time my own development and version&nbsp;control methodologies have matured and I've been very successfully using git to manage my own projects. After a recent conversation with fellow <a href="https://eightwone.com" target="_blank" rel="noopener noreferrer">MVP Michel de Rooij</a>&nbsp;about his use of GitHub as a repository for his scripts, I decided to follow suit and have&nbsp;created a public GitHub repositories for each of my scripts. You <a href="https://github.com/cgoosen" target="_blank" rel="noopener noreferrer">can find these here.</a></p>
<p>I will continue to make code signed versions of my scripts available in the TechNet gallery for those who prefer to just download and use them. Links to those are below:</p>
<ul>
<li><a href="https://gallery.technet.microsoft.com/Connect-EXOps1-Connect-to-4d694663" target="_blank" rel="noopener noreferrer">Connect-365.ps1</a></li>
<li><a href="https://gallery.technet.microsoft.com/Connect-EXOps1-Connect-to-9c3854ea" target="_blank" rel="noopener noreferrer">Connect-EXO.ps1</a></li>
<li><a href="https://gallery.technet.microsoft.com/Get-AZCopyGUIps1-AZCopy-b60d2df8" target="_blank" rel="noopener noreferrer">Get-AZCopyGUI.ps1</a></li>
<li><a href="https://gallery.technet.microsoft.com/Fix-ProxyAddressps1-7036dfa1" target="_blank" rel="noopener noreferrer">Fix-ProxyAddress.ps1</a></li>
</ul>


        
    </div>

    <footer class="post-footer">
        <div class="share">Share
            <ul class="social-networks">
                <li class="share-facebook"><a href="https://www.facebook.com/sharer.php?s=100&p[title]=My PowerShell scripts are now available on GitHub&p[summary]=Ever since I first started sharing scripts on my blog, I've had a bunch of people reach out to me with stories of how they've used my cod...&p[url]=http://172.16.7.177:4000/2018/01/my-powershell-scripts-are-now-available-on-github" class="s_facebook" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#facebook-icon"></use></svg></a></a></li>
                <li class="share-twitter"><a href="http://twitter.com/share?url=http://172.16.7.177:4000/2018/01/my-powershell-scripts-are-now-available-on-github&text=Ever since I first started sharing scripts on my blog, I've had a bunch of people reach out to me with stories of how they've used my cod...&hashtags=" rel="noreferrer" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#twitter-icon"></use></svg></a></li>
            </ul>
        </div>
        
        <div class="tags">
            <ul>
                
            </ul>
        </div>
        
    </footer>
</article>

<article class="post" role="article" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="post-header">
        <ul>
            <li><time datetime="2017-03-29T01:15:11-05:00" itemprop="datePublished">29 Mar, 2017</time></li>
            
        </ul>
        <h2 itemprop="name headline"><a href="http://172.16.7.177:4000/2017/03/script-connect-365-ps-connect-to-office-365-services-using-remote-powershell">Script: Connect-365.ps1 - Connect to Office 365 services using remote PowerShell</a></h2>
    </header>

    <div class="post-content">
        <p>I'm excited to announce the release of Connect-365! Back 2012, I put together a basic script with a GUI to simplify connecting to Exchange Online via remote PowerShell. I had never intended to make the script publicly available and it was just something I used myself. After a couple years I realized that it had been shared with so many colleagues and clients that I decided to clean it up and publish it on the TechNet gallery. Connect-EXO was born! Here's a screenshot of the original first version:</p>
<p style="text-align: center;"><a href="https://www.cgoosen.com/wp-content/uploads/2017/03/Capture1.png"><img class="aligncenter size-medium wp-image-2684" src="https://www.cgoosen.com/wp-content/uploads/2017/03/Capture1-300x281.png" alt="" width="300" height="281" /></a></p>
<p style="text-align: left;">Over time the script matured <a href="https://www.cgoosen.com/2014/10/script-connect-exo-ps1-connect-to-exchange-online-using-remote-powershell/" target="_blank" rel="noopener">into what Connect-EXO is today</a>. One of the challenges in the early version was that I used WPF for the GUI, this was problematic for older versions of PowerShell so I made the decision to port it to Windows Forms for backward compatibility. Forms is old and added a lot of bloat and since&nbsp;backwards compatibility is no longer a concern, I decided to move back to WPF. Connect-365 is essentially the next version of Connect-EXO, I renamed it so more accurately reflect it's purpose and this will allow me to continue to maintain Connect-EXO.</p>
<p style="text-align: left;">Connect-365 features a GUI that will prompt for your tenant credentials and then connect to various Office 365 services using remote PowerShell. The built-in prerequisite checker will check to ensure that the correct modules are installed and provide a download link for those that are not.</p>
<p>The current version of the script allows connectivity to:</p>
<ul>
<li>Exchange Online</li>
<li>Azure Active Directory (using v2 module)</li>
<li>Office 365 Security &amp; Compliance Center</li>
<li>Skype for Business Online</li>
<li>SharePoint Online</li>
</ul>
<p><strong>Requirements:</strong><br />
This script will work natively in PowerShell 4.0+</p>
<p><strong>Usage:</strong><br />
There are no parameters or switches, simply execute the script: <em>.\Connect-365.ps1</em></p>
<p><strong>Execution Policy:</strong><br />
This script has been digitally signed and will run just fine under a "RemoteSigned" execution policy</p>
<p><strong>Screenshots:</strong></p>
<p style="text-align: center;"><a href="https://www.cgoosen.com/wp-content/uploads/2019/02/Screen-Shot-2019-02-27-at-2.09.37-PM.png"><img class="aligncenter size-full wp-image-3707" src="https://www.cgoosen.com/wp-content/uploads/2019/02/Screen-Shot-2019-02-27-at-2.09.37-PM.png" alt="" width="539" height="415" /></a></p>
<p style="text-align: center;"><a href="https://www.cgoosen.com/wp-content/uploads/2017/03/Screen-Shot-2019-02-27-at-2.09.09-PM.png"><img class="aligncenter size-full wp-image-3710" src="https://www.cgoosen.com/wp-content/uploads/2017/03/Screen-Shot-2019-02-27-at-2.09.09-PM.png" alt="" width="539" height="415" /></a></p>
<p style="text-align: center;"><a href="https://www.cgoosen.com/wp-content/uploads/2017/03/c.png"><img class="aligncenter wp-image-2687" src="https://www.cgoosen.com/wp-content/uploads/2017/03/c.png" alt="" width="628" height="125" /></a></p>
<p><strong>Roadmap:</strong></p>
<ul>
<li><del>Support Azure AD v1 and v2</del> - Removed as v1 is depreciated</li>
<li><del>Support for Exchange Online MFA (via module)</del> - Done!</li>
<li>Derive SPO Admin URL</li>
<li>Auto-install prerequisites</li>
<li>Much more..</li>
</ul>
<p><strong>Download:<br />
</strong>I have published it to the TechNet Gallery, <a href="http://cgoo.se/1srvTiS" target="_blank" rel="noopener">it can be downloaded by clicking here&hellip;</a></p>


        
    </div>

    <footer class="post-footer">
        <div class="share">Share
            <ul class="social-networks">
                <li class="share-facebook"><a href="https://www.facebook.com/sharer.php?s=100&p[title]=Script: Connect-365.ps1 - Connect to Office 365 services using remote PowerShell&p[summary]=I'm excited to announce the release of Connect-365! Back 2012, I put together a basic script with a GUI to simplify connecting to Exchang...&p[url]=http://172.16.7.177:4000/2017/03/script-connect-365-ps-connect-to-office-365-services-using-remote-powershell" class="s_facebook" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#facebook-icon"></use></svg></a></a></li>
                <li class="share-twitter"><a href="http://twitter.com/share?url=http://172.16.7.177:4000/2017/03/script-connect-365-ps-connect-to-office-365-services-using-remote-powershell&text=I'm excited to announce the release of Connect-365! Back 2012, I put together a basic script with a GUI to simplify connecting to Exchang...&hashtags=" rel="noreferrer" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#twitter-icon"></use></svg></a></li>
            </ul>
        </div>
        
        <div class="tags">
            <ul>
                
            </ul>
        </div>
        
    </footer>
</article>

<article class="post" role="article" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="post-header">
        <ul>
            <li><time datetime="2017-03-15T10:49:32-05:00" itemprop="datePublished">15 Mar, 2017</time></li>
            
        </ul>
        <h2 itemprop="name headline"><a href="http://172.16.7.177:4000/2017/03/connecting-to-exchange-online-with-remote-powershell-from-a-mac">Connecting to Exchange Online with remote PowerShell from a Mac</a></h2>
    </header>

    <div class="post-content">
        <p>Yes! it is finally possible to connect to Exchange Online from PowerShell installed on MacOS. I noticed some tweets <a href="https://mattmcnabb.github.io/O365-PowerShell-On-Linux" target="_blank" rel="noopener noreferrer">about this being possible on Linux</a> earlier in the week so I thought I&rsquo;d re-visit testing it on MacOS. PowerShell remoting has been available in the MacOs version since powershell-6.0.0-alpha.15, but it didn&rsquo;t include the ability to specify a &ldquo;ConnectionUri&rsquo; as the endpoint &ndash; it only worked with server names and IP addresses. powershell-6.0.0-alpha.17 which was recently released now includes this functionality.</p>
<p>The first thing you need to do it <a href="https://github.com/PowerShell/PowerShell" target="_blank" rel="noopener noreferrer">download and install the latest release from here</a>, you&rsquo;ll want to download at least powershell-6.0.0-alpha.17</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2017/03/Screen-Shot-2017-03-15-at-3.47.08-PM.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="Screen Shot 2017-03-15 at 3.47.08 PM" src="http://www.cgoosen.com/wp-content/uploads/2017/03/Screen-Shot-2017-03-15-at-3.47.08-PM_thumb.png" alt="Screen Shot 2017-03-15 at 3.47.08 PM" width="410" height="290" border="0" /></a></p>
<p align="left">Next launch PowerShell and confirm the version:</p>
<p>[powershell]<br />
$PSVersionTable<br />
[/powershell]</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2017/03/Screen-Shot-2017-03-15-at-4.31.53-PM.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="Screen Shot 2017-03-15 at 4.31.53 PM" src="http://www.cgoosen.com/wp-content/uploads/2017/03/Screen-Shot-2017-03-15-at-4.31.53-PM_thumb.png" alt="Screen Shot 2017-03-15 at 4.31.53 PM" width="410" height="263" border="0" /></a></p>
<p align="left">We are now ready to run establish our remote session. First let&rsquo;s define our credentials:</p>
<p>[powershell]<br />
$UserCredential = Get-Credential<br />
[/powershell]</p>
<p align="left">Then create the session:</p>
<p>[powershell]<br />
$Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid -Credential $UserCredential -Authentication Basic -AllowRedirection<br />
[/powershell]</p>
<p align="left">And finally, import that session:</p>
<p>[powershell]<br />
Import-PSSession $Session<br />
[/powershell]</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2017/03/Screen-Shot-2017-03-15-at-4.41.16-PM.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="Screen Shot 2017-03-15 at 4.41.16 PM" src="http://www.cgoosen.com/wp-content/uploads/2017/03/Screen-Shot-2017-03-15-at-4.41.16-PM_thumb.png" alt="Screen Shot 2017-03-15 at 4.41.16 PM" width="410" height="263" border="0" /></a></p>
<p align="left">Once connected you have all the Exchange Online cmdlets available to you:</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2017/03/Screen-Shot-2017-03-15-at-4.46.02-PM.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="Screen Shot 2017-03-15 at 4.46.02 PM" src="http://www.cgoosen.com/wp-content/uploads/2017/03/Screen-Shot-2017-03-15-at-4.46.02-PM_thumb.png" alt="Screen Shot 2017-03-15 at 4.46.02 PM" width="410" height="263" border="0" /></a></p>
<p align="left">I haven&rsquo;t thoroughly tested it yet, but I look forward to spending some time using it soon!</p>


        
    </div>

    <footer class="post-footer">
        <div class="share">Share
            <ul class="social-networks">
                <li class="share-facebook"><a href="https://www.facebook.com/sharer.php?s=100&p[title]=Connecting to Exchange Online with remote PowerShell from a Mac&p[summary]=Yes! it is finally possible to connect to Exchange Online from PowerShell installed on MacOS. I noticed some tweets about this being poss...&p[url]=http://172.16.7.177:4000/2017/03/connecting-to-exchange-online-with-remote-powershell-from-a-mac" class="s_facebook" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#facebook-icon"></use></svg></a></a></li>
                <li class="share-twitter"><a href="http://twitter.com/share?url=http://172.16.7.177:4000/2017/03/connecting-to-exchange-online-with-remote-powershell-from-a-mac&text=Yes! it is finally possible to connect to Exchange Online from PowerShell installed on MacOS. I noticed some tweets about this being poss...&hashtags=" rel="noreferrer" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#twitter-icon"></use></svg></a></li>
            </ul>
        </div>
        
        <div class="tags">
            <ul>
                
            </ul>
        </div>
        
    </footer>
</article>

<article class="post" role="article" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="post-header">
        <ul>
            <li><time datetime="2016-07-26T14:23:53-05:00" itemprop="datePublished">26 Jul, 2016</time></li>
            
        </ul>
        <h2 itemprop="name headline"><a href="http://172.16.7.177:4000/2016/07/automating-archive-folder-creation-in-exchange-online-mailboxes">Automating archive folder creation in Exchange Online mailboxes</a></h2>
    </header>

    <div class="post-content">
        <p align="left">If you are using Outlook 2016 on Windows or Mac you will have noticed the recent addition of a one-click &lsquo;Archive&rsquo; button to the ribbon. The addition of the archive button was <a href="https://blogs.office.com/2016/02/25/february-office-365-updates/" target="_blank">announced at the end of February</a>, but seems to have caught a bunch of customers by surprise and there appears to be some confusion about it&rsquo;s intended purpose. If you are unfamiliar with the one-click &lsquo;Archive&rsquo; button, here&rsquo;s what it looks like:</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2016/07/a.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="a" src="http://www.cgoosen.com/wp-content/uploads/2016/07/a_thumb.png" alt="a" width="240" height="140" border="0" /></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="http://www.cgoosen.com/wp-content/uploads/2016/07/b.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="b" src="http://www.cgoosen.com/wp-content/uploads/2016/07/b_thumb.png" alt="b" width="206" height="120" border="0" /></a></p>
<p align="left">The archive button is intended to make archiving email a one-click operation, but this does not archive email to an Online Archive and does not require users to have an Online Archive enabled. Instead, the button will file email to an &lsquo;Archive&rsquo; folder in your existing mailbox. The intention here is that this button provides a single-click way to clean or declutter your inbox of messages that you have already read. It is important to understand the following about the archive button:</p>
<ul>
<li>
<div align="left">The archive button cannot be used to send email messages to the Online Archive.</div>
</li>
<li>
<div align="left">Since the archive folder is a folder in the root of the mailbox, moving email to it will not reduce the overall size of the mailbox.</div>
</li>
</ul>
<p align="left">If a folder called &lsquo;Archive&rsquo; does not already exist in the root of the mailbox, the user will be prompted to create one:</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2016/07/1.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="1" src="http://www.cgoosen.com/wp-content/uploads/2016/07/1_thumb.png" alt="1" width="416" height="112" border="0" /></a></p>
<p align="left">Certain organizations may feel like this creates confusion amongst their user community and would therefore like to automate the create of the &lsquo;Archive&rsquo; folder in their user mailboxes. Fortunately, MVP (and fellow Aussie!) <a href="https://mvp.microsoft.com/en-us/PublicProfile/10145?fullName=Glen%20%20Scales" target="_blank">Glen Scales</a> has a <a href="http://gsexdev.blogspot.com/2015/09/ews-create-mailbox-folder-powershell.html" target="_blank">great solution for creating mailbox folders using PowerShell the EWS managed API.</a> In order to use his module, you will need to download and install the <a href="http://go.microsoft.com/fwlink/?LinkId=255472" target="_blank">EWS managed API from here.</a> Once installed, you will need to connect to <a href="http://www.cgoosen.com/2014/10/script-connect-exo-ps1-connect-to-exchange-online-using-remote-powershell/" target="_blank">Exchange Online via remote PowerShell</a> and import the module. It them becomes a matter of using the Create-Folder cmdlet included in the module. The module has few parameters and a lot of other functionality but we only need the following:</p>
<p>[powershell]<br />
Create-Folder -MailboxName user@domain.com -NewFolderName Archive<br />
[/powershell]</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2016/07/3.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="3" src="http://www.cgoosen.com/wp-content/uploads/2016/07/3_thumb.png" alt="3" width="534" height="167" border="0" /></a></p>
<p>With some minor tweaks to Glen&rsquo;s code, we can easily script this process for multiple (or all) mailboxes:</p>
<p>[powershell]<br />
function Load-EWSManagedAPI{<br />
    param(<br />
    )<br />
 	Begin<br />
	{<br />
		## Load Managed API dll<br />
		###CHECK FOR EWS MANAGED API, IF PRESENT IMPORT THE HIGHEST VERSION EWS DLL, ELSE EXIT<br />
		$EWSDLL = (($(Get-ItemProperty -ErrorAction SilentlyContinue -Path Registry::$(Get-ChildItem -ErrorAction SilentlyContinue -Path 'Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Exchange\Web Services'|Sort-Object Name -Descending| Select-Object -First 1 -ExpandProperty Name)).'Install Directory') + "Microsoft.Exchange.WebServices.dll")<br />
		if (Test-Path $EWSDLL)<br />
		    {<br />
		    Import-Module $EWSDLL<br />
		    }<br />
		else<br />
		    {<br />
		    "$(get-date -format yyyyMMddHHmmss):"<br />
		    "This script requires the EWS Managed API 1.2 or later."<br />
		    "Please download and install the current version of the EWS Managed API from"<br />
		    "http://go.microsoft.com/fwlink/?LinkId=255472"<br />
		    ""<br />
		    "Exiting Script."<br />
		    exit<br />
		    }<br />
  	}<br />
}</p>
<p>function Connect-Exchange{<br />
    param(<br />
    	[Parameter(Position=0, Mandatory=$true)] [string]$MailboxName,<br />
		[Parameter(Position=1, Mandatory=$true)] [System.Management.Automation.PSCredential]$Credentials<br />
    )<br />
 	Begin<br />
		 {<br />
		Load-EWSManagedAPI</p>
<p>		## Set Exchange Version<br />
		$ExchangeVersion = [Microsoft.Exchange.WebServices.Data.ExchangeVersion]::Exchange2010_SP1</p>
<p>		## Create Exchange Service Object<br />
		$service = New-Object Microsoft.Exchange.WebServices.Data.ExchangeService($ExchangeVersion)  </p>
<p>		#Credentials<br />
		$creds = New-Object System.Net.NetworkCredential($Credentials.UserName.ToString(),$Credentials.GetNetworkCredential().password.ToString())<br />
		$service.Credentials = $creds       </p>
<p>		#CAS URL hardcoded for Exchange Online </p>
<p>		$uri=[system.URI] "https://outlook.office365.com/EWS/Exchange.asmx"<br />
		$service.Url = $uri    </p>
<p>        if(!$service.URL){<br />
			throw "Error connecting to EWS"<br />
		}<br />
		else<br />
		{<br />
			return $service<br />
		}<br />
	}<br />
}</p>
<p>function Create-Folder{<br />
    param(<br />
    	[Parameter(Position=0, Mandatory=$true)] [string]$MailboxName,<br />
		[Parameter(Position=1, Mandatory=$true)] [System.Management.Automation.PSCredential]$Credentials,<br />
		[Parameter(Position=2, Mandatory=$true)] [String]$NewFolderName<br />
    )<br />
 	Begin<br />
	 {<br />
		$service = Connect-Exchange -MailboxName $MailboxName -Credentials $Credentials<br />
		$NewFolder = new-object Microsoft.Exchange.WebServices.Data.Folder($service)<br />
		$NewFolder.DisplayName = $NewFolderName<br />
        $NewFolder.FolderClass = "IPF.Note"</p>
<p>        # Bind to the MsgFolderRoot folder<br />
		$folderid= new-object Microsoft.Exchange.WebServices.Data.FolderId([Microsoft.Exchange.WebServices.Data.WellKnownFolderName]::MsgFolderRoot,$MailboxName)<br />
		$EWSParentFolder = [Microsoft.Exchange.WebServices.Data.Folder]::Bind($service,$folderid)</p>
<p>		#Define Folder Veiw Really only want to return one object<br />
		$fvFolderView = new-object Microsoft.Exchange.WebServices.Data.FolderView(1)<br />
		#Define a Search folder that is going to do a search based on the DisplayName of the folder<br />
		$SfSearchFilter = new-object Microsoft.Exchange.WebServices.Data.SearchFilter+IsEqualTo([Microsoft.Exchange.WebServices.Data.FolderSchema]::DisplayName,$NewFolderName)<br />
		#Do the Search<br />
		$findFolderResults = $service.FindFolders($EWSParentFolder.Id,$SfSearchFilter,$fvFolderView)<br />
		if ($findFolderResults.TotalCount -eq 0){<br />
		    Write-host ("Folder Doesn't Exist") -ForegroundColor Yellow<br />
			$NewFolder.Save($EWSParentFolder.Id)<br />
			Write-host ("Folder Created") -ForegroundColor Green<br />
		}<br />
		else{<br />
		    Write-error ("Folder already Exist with that Name")<br />
		}  </p>
<p>	 }<br />
}</p>
<p># Define tenant credentials<br />
$Credentials = Get-Credential</p>
<p># Define mailboxes that need the archive folder created<br />
# Get all mailboxes<br />
$Mailboxes = Get-Mailbox -ResultSize Unlimited | Where-Object {$_.Name -notlike "DiscoverySearchMailbox*"}</p>
<p># Or import a list of mailboxes from .txt<br />
# $Mailboxes = Get-Content C:\Temp\Mailboxes.txt</p>
<p># Create the folder<br />
ForEach ($MailboxName in $Mailboxes) {<br />
    Write-host "Processing $MailboxName" -ForegroundColor Yellow<br />
    Create-Folder -MailboxName $MailboxName.PrimarySmtpAddress -NewFolderName Archive -Credentials $Credentials<br />
    }<br />
[/powershell]</p>
<p align="left">Once the &lsquo;Archive&rsquo; folder has been created, it will become the destination for all messages that are selected when the &lsquo;Archive&rsquo; button is clicked.</p>
<p align="left">A word of caution: If you have a large number of mailboxes, you may run into throttling issues if you attempt to do this on all mailboxes at the same time so it is definitely worth considering a phased rollout in larger environments.</p>
<p align="left">Glen has some great stuff <a href="http://gsexdev.blogspot.com" target="_blank">on his blog so be sure to check it out here</a>.</p>


        
    </div>

    <footer class="post-footer">
        <div class="share">Share
            <ul class="social-networks">
                <li class="share-facebook"><a href="https://www.facebook.com/sharer.php?s=100&p[title]=Automating archive folder creation in Exchange Online mailboxes&p[summary]=If you are using Outlook 2016 on Windows or Mac you will have noticed the recent addition of a one-click &lsquo;Archive&rsquo; button to ...&p[url]=http://172.16.7.177:4000/2016/07/automating-archive-folder-creation-in-exchange-online-mailboxes" class="s_facebook" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#facebook-icon"></use></svg></a></a></li>
                <li class="share-twitter"><a href="http://twitter.com/share?url=http://172.16.7.177:4000/2016/07/automating-archive-folder-creation-in-exchange-online-mailboxes&text=If you are using Outlook 2016 on Windows or Mac you will have noticed the recent addition of a one-click &lsquo;Archive&rsquo; button to ...&hashtags=" rel="noreferrer" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#twitter-icon"></use></svg></a></li>
            </ul>
        </div>
        
        <div class="tags">
            <ul>
                
            </ul>
        </div>
        
    </footer>
</article>

<article class="post" role="article" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="post-header">
        <ul>
            <li><time datetime="2016-06-30T12:46:19-05:00" itemprop="datePublished">30 Jun, 2016</time></li>
            
        </ul>
        <h2 itemprop="name headline"><a href="http://172.16.7.177:4000/2016/06/minor-update-to-my-connect-exo-ps1-script">Minor update to my Connect-EXO.ps1 script</a></h2>
    </header>

    <div class="post-content">
        <p>I've just published an updated version of my Connect-EXO.ps1 script. This version, (version 3.2) includes a very minor fix for those using German language keyboards. This update is the result of testing and feedback from the TechNet community and I wanted to thank all those involved.</p>
<p>I have been planning some big updates to this script and work on version 4.0 will begin soon - watch this space!</p>
<p>The update has been published to the TechNet Gallery,&nbsp;<a href="http://cgoo.se/1srvTiS" target="_blank">it can be downloaded by clicking here&hellip;</a></p>


        
    </div>

    <footer class="post-footer">
        <div class="share">Share
            <ul class="social-networks">
                <li class="share-facebook"><a href="https://www.facebook.com/sharer.php?s=100&p[title]=Minor update to my Connect-EXO.ps1 script&p[summary]=I've just published an updated version of my Connect-EXO.ps1 script. This version, (version 3.2) includes a very minor fix for those usin...&p[url]=http://172.16.7.177:4000/2016/06/minor-update-to-my-connect-exo-ps1-script" class="s_facebook" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#facebook-icon"></use></svg></a></a></li>
                <li class="share-twitter"><a href="http://twitter.com/share?url=http://172.16.7.177:4000/2016/06/minor-update-to-my-connect-exo-ps1-script&text=I've just published an updated version of my Connect-EXO.ps1 script. This version, (version 3.2) includes a very minor fix for those usin...&hashtags=" rel="noreferrer" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#twitter-icon"></use></svg></a></li>
            </ul>
        </div>
        
        <div class="tags">
            <ul>
                
            </ul>
        </div>
        
    </footer>
</article>

<article class="post" role="article" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="post-header">
        <ul>
            <li><time datetime="2016-05-31T11:05:03-05:00" itemprop="datePublished">31 May, 2016</time></li>
            
        </ul>
        <h2 itemprop="name headline"><a href="http://172.16.7.177:4000/2016/05/using-a-certificate-to-encrypt-credentials-in-automated-powershell-scripts-an-update">Using a certificate to encrypt credentials in automated PowerShell scripts &ndash; An Update!</a></h2>
    </header>

    <div class="post-content">
        <p><a href="http://www.cgoosen.com/2015/02/using-a-certificate-to-encrypt-credentials-in-automated-powershell-scripts/" target="_blank">Early last year I wrote a post</a> about encrypting script credentials using certificates. At the time, someone (thanks <a href="https://davewyatt.wordpress.com/" target="_blank">Dave Wyatt!</a>) commented on the post suggesting a couple of alternative methods to encrypt and decrypt the data, in particular I was interested in the Protect-CmsMessage and Unprotect-CmsMessage cmdlets included in PowerShell 5.0. Now that PowerShell 5.0 is more widespread I wanted to post a quick update about how these cmdlets can help simplify the process. The process is similar, but there are less steps and it is important to note that the certificate must contain the Data Encipherment or Key Encipherment key usage, and include the Document Encryption Enhanced Key Usage (1.3.6.1.4.1.311.80.1).</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2016/05/Capture.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="Capture" src="http://www.cgoosen.com/wp-content/uploads/2016/05/Capture_thumb.png" alt="Capture" width="426" height="544" border="0" /></a></p>
<p>Let&rsquo;s start by first locating our certificate using the Get-ChildItem cmdlet:</p>
<p>[powershell]$Cert = Get-ChildItem Cert:\LocalMachine\My | Where-Object {$_.Subject -like "CN=PowerShell Automation*"}[/powershell]</p>
<p>Next we encrypt our password using that certificate:</p>
<p>[powershell]$Password = 'MyPassword'<br />
Protect-CmsMessage -To $Cert -Content $Password<br />
[/powershell]</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2016/05/Capture-1.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="Capture" src="http://www.cgoosen.com/wp-content/uploads/2016/05/Capture_thumb-1.png" alt="Capture" width="960" height="200" border="0" /></a></p>
<p>You&rsquo;ll notice that the encrypted password is presented a little differently. You will&nbsp;need to include the entire block in your script.</p>
<p>Unencrypting the password in your script basically involves repeating this process in reverse:</p>
<p>[powershell]$Cert = Get-ChildItem Cert:\LocalMachine\My | Where-Object {$_.Subject -like 'CN=PowerShell Automation*'}<br />
$EncryptedPwd = @'<br />
-----BEGIN CMS-----<br />
MIIBqAYJKoZIhvcNAQcDoIIBmTCCAZUCAQAxggFQMIIBTAIBADA0MCAxHjAcBgNVBAMMFVBvd2Vy<br />
U2hlbGwgQXV0b21hdGlvbgIQOEd4fYDturxF77V7lEytlDANBgkqhkiG9w0BAQcwAASCAQB0z92N<br />
HrgQ84JxSV7RYpwSMPJRuSXlgVubOIew8KsYXr/E8kd/wOyT/2NPi3d+4xb67CLUM4infqOrt9Q+<br />
ReAtINvfVB5EPc9wU8yDpdz+WKProT4RJ94nzGH5qW5SK4O1Siu0VSPJZaCNb+CmYNFNNvLu6MN4<br />
pDqOiqZnv+j/rUxhrHX+U3E+eJq5P0gsZUwRaXZoAgGyV6SvZdUsbPYZ+hMPG0DruF/83SK6MOZM<br />
yVnGOmeP8e8/b/Rk2Y24JvDcROwRvK2+uj2Oy3ukw1WS4TxMy2V4lkjTYvwIO+bukjFCCtaR4Q63<br />
C6fx9OArx+uMbPmzkFgmG0w3jFVNnjjMMDwGCSqGSIb3DQEHATAdBglghkgBZQMEASoEEPdMffTC<br />
N+IvYDNFmuWKgZqAELsAZyE9I0POh/j64DNTsLI=<br />
-----END CMS-----<br />
'@<br />
$DecryptedPwd = $EncryptedPwd | Unprotect-CmsMessage -To $Cert | ConvertTo-SecureString -AsPlainText -Force<br />
[/powershell]</p>
<p>You can now use $DecryptedPwd to generate your credentials similar to the following:</p>
<p>[powershell]<br />
$MSOLUsername = 'serviceAcc@tenant.onmicrosoft.com'<br />
$MSOLCredentials = New-Object System.Management.Automation.PSCredential ($MSOLUsername,$DecryptedPwd)<br />
Connect-MSOLService -Credential $MSOLCredentials<br />
[/powershell]</p>


        
    </div>

    <footer class="post-footer">
        <div class="share">Share
            <ul class="social-networks">
                <li class="share-facebook"><a href="https://www.facebook.com/sharer.php?s=100&p[title]=Using a certificate to encrypt credentials in automated PowerShell scripts &ndash; An Update!&p[summary]=Early last year I wrote a post about encrypting script credentials using certificates. At the time, someone (thanks Dave Wyatt!) commente...&p[url]=http://172.16.7.177:4000/2016/05/using-a-certificate-to-encrypt-credentials-in-automated-powershell-scripts-an-update" class="s_facebook" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#facebook-icon"></use></svg></a></a></li>
                <li class="share-twitter"><a href="http://twitter.com/share?url=http://172.16.7.177:4000/2016/05/using-a-certificate-to-encrypt-credentials-in-automated-powershell-scripts-an-update&text=Early last year I wrote a post about encrypting script credentials using certificates. At the time, someone (thanks Dave Wyatt!) commente...&hashtags=" rel="noreferrer" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#twitter-icon"></use></svg></a></li>
            </ul>
        </div>
        
        <div class="tags">
            <ul>
                
            </ul>
        </div>
        
    </footer>
</article>

<article class="post" role="article" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="post-header">
        <ul>
            <li><time datetime="2016-04-12T04:31:15-05:00" itemprop="datePublished">12 Apr, 2016</time></li>
            
        </ul>
        <h2 itemprop="name headline"><a href="http://172.16.7.177:4000/2016/04/my-connect-exo-ps1-script-has-been-updated-2">My Connect-EXO.ps1 script has been updated!</a></h2>
    </header>

    <div class="post-content">
        <p>I've just published an updated version of my Connect-EXO.ps1 script. Version 3.1 includes the ability&nbsp;to connect to the&nbsp;Office 365 Security &amp; Compliance Center. Based on the options selected it will connect to either or all&nbsp;services with Exchange Online being the only one selected by default. Here is a screenshot of the new interface:</p>
<p style="text-align: center;"><a href="http://www.cgoosen.com/wp-content/uploads/2014/10/cap1.png" rel="attachment wp-att-1504"><img class="aligncenter wp-image-1504" src="http://www.cgoosen.com/wp-content/uploads/2014/10/cap1.png" alt="GUI" width="454" height="298" /></a></p>
<p style="text-align: left;">The update has been published to the TechNet Gallery, <a href="http://cgoo.se/1srvTiS" target="_blank">it can be downloaded by clicking here&hellip;</a></p>


        
    </div>

    <footer class="post-footer">
        <div class="share">Share
            <ul class="social-networks">
                <li class="share-facebook"><a href="https://www.facebook.com/sharer.php?s=100&p[title]=My Connect-EXO.ps1 script has been updated!&p[summary]=I've just published an updated version of my Connect-EXO.ps1 script. Version 3.1 includes the ability&nbsp;to connect to the&nbsp;Office ...&p[url]=http://172.16.7.177:4000/2016/04/my-connect-exo-ps1-script-has-been-updated-2" class="s_facebook" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#facebook-icon"></use></svg></a></a></li>
                <li class="share-twitter"><a href="http://twitter.com/share?url=http://172.16.7.177:4000/2016/04/my-connect-exo-ps1-script-has-been-updated-2&text=I've just published an updated version of my Connect-EXO.ps1 script. Version 3.1 includes the ability&nbsp;to connect to the&nbsp;Office ...&hashtags=" rel="noreferrer" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#twitter-icon"></use></svg></a></li>
            </ul>
        </div>
        
        <div class="tags">
            <ul>
                
            </ul>
        </div>
        
    </footer>
</article>

<article class="post" role="article" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="post-header">
        <ul>
            <li><time datetime="2016-03-30T09:30:09-05:00" itemprop="datePublished">30 Mar, 2016</time></li>
            
        </ul>
        <h2 itemprop="name headline"><a href="http://172.16.7.177:4000/2016/03/using-powershell-to-automate-office-365-license-assignment">Using PowerShell to automate Office 365 license assignment</a></h2>
    </header>

    <div class="post-content">
        <p>The move to Office 365 almost always requires changes to existing operational processes. One of the processes that inevitably requires an update is the provisioning process and the extent of these changes will differ from organization to organization and depend on the maturity of your identity lifecycle management process. In many environments, license assignment can be easily automated using a scheduled task and PowerShell so I wanted to put together a post that provides an outline on how this can be done.</p>
<p>Before getting into it, I just want to add a little disclaimer to this post &ndash; I love PowerShell and because I love PowerShell, I like to use it, but this doesn&rsquo;t mean it is always fit for purpose. Each environment is different so I would urge you to consider all options before implementing a full blown PowerShell provisioning process because you may already own better tools for the job (FIM/MIM, etc). These tools often take a while to implement when done properly, so PowerShell could also be a great stop-gap solution. This post is intended to provide a foundation that helps you put together your own process and should not necessarily be implemented &ldquo;as-is&rdquo;.</p>
<p>With that out of the way, there are some requirements to think of as well. The server executing the script will need the following:</p>
<ul>
<li>The ability to connect to Azure AD via remote PowerShell which requires the Azure AD Module &ndash;&nbsp; <a title="https://msdn.microsoft.com/en-us/library/jj151815.aspx" href="https://msdn.microsoft.com/en-us/library/jj151815.aspx" target="_blank">Click here for more info</a></li>
<li>Remote Server Administration Tools &ndash; RSAT</li>
<li>A certificate to encrypt and decrypt your service account passwords. This certificate can be from an internal CA &ndash; <a href="http://www.cgoosen.com/2015/02/using-a-certificate-to-encrypt-credentials-in-automated-powershell-scripts/" target="_blank">See this post for more info</a></li>
<li>Service accounts with the relevant permissions</li>
<li>Relay permission on your Exchange server &ndash; Used for send report emails</li>
</ul>
<p>The scenario I will be addressing in this post is to automate mailbox provisioning and license assignment in a hybrid deployment. All new mailboxes get provisioned as remote mailboxes directly in Office 365 and users are assigned the relevant Office 365 license. Each user account has an entry in the &lsquo;extensionAttribute1&rsquo; attribute which determines the license they will be assigned, eg. E3 or Exchange Plan 2. We make use of 2 security groups during this process so users can be created in any OU as long as that OU is being synchronized to Azure AD. These groups are:</p>
<ul>
<li>O365_Provision &ndash; Starts the provisioning process. New accounts are added to this group once they have been created in Active Directory</li>
<li>O365_License &ndash; Used by the script to keep track of users who still need to have licenses assigned</li>
</ul>
<p>At a high level the workflow looks something like this:</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2016/03/FlowChart.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-width: 0px;" title="FlowChart" src="http://www.cgoosen.com/wp-content/uploads/2016/03/FlowChart_thumb.png" alt="FlowChart" width="1020" height="692" border="0" /></a></p>
<p>Lets start by looking at the variables and functions we need. Here you can define you license SKUs, service account credentials, etc:</p>
<p>[powershell]<br />
# Modules<br />
Import-Module ActiveDirectory</p>
<p># Variables - Edit these<br />
#########################<br />
$ErrorActionPreference = 'Stop'<br />
$ExchangeServer = 'you_exchange_server'<br />
$FromAddress = 'Provisioning Service
<provisioning@yourdomain.com>'<br />
$ToAddress = 'you@yourdomain.com'<br />
$ADUsername = 'YourDomain\service_acc'<br />
$RoutingDomain = 'yourtenant.mail.onmicrosoft.com'<br />
$ADEncryptedPwd = ''<br />
$MSOLUsername = 'service_acc@yourtenant.onmicrosoft.com'<br />
$MSOLEncryptedPwd = ''<br />
$Cert = Get-ChildItem Cert:\LocalMachine\My | Where-Object {$_.Subject -like 'CN=Provisioning Service*'}<br />
$E3SKU = 'yourtenant:ENTERPRISEPACK'<br />
$EP2SKU = 'yourtenant:EXCHANGEENTERPRISE'</p>
<p>#Email Styling<br />
$EmailBody = @"<br />
<html><br />
<head></p>
<style>
	.table {<br />
		border:1px solid #F0F0F0;<br />
        border-collapse: collapse;<br />
		padding:10px;<br />
	}<br />
	.table th {<br />
		border:1px solid #F0F0F0;<br />
		padding:10px;<br />
		background:#F0F0F0;<br />
	}<br />
	.table td {<br />
		border:1px solid #F0F0F0;<br />
		padding:10px;<br />
	}<br />
</style>
<p></head><br />
<body></p>
<p>Hello,</p>
<p>This is an automated report from the Office 365 Provisioning Service. The following user accounts have been successfully provisioned in Office 365:</p>
<table class="table">
<thead>
<tr>
<th>Username</th>
<th>Email Address</th>
<th>License Assigned</th>
</tr>
</thead>
<tbody>
"@<br />
$EmailBodyClosure = @"</p>
<p>Regards,
<p>Provisioning Service</p>
<p> </body><br />
 </html><br />
"@<br />
###########################</p>
<p># Functions<br />
# Function to create report email<br />
function Send-Report{<br />
    $Msg = New-Object Net.Mail.MailMessage<br />
    $Smtp = New-Object Net.Mail.SmtpClient($ExchangeServer)<br />
    $Msg.From = $FromAddress<br />
    $Msg.To.Add($ToAddress)<br />
    $Msg.Subject = $EmailSubject<br />
    $Msg.Body = $EmailBody<br />
    $Msg.IsBodyHTML = $true<br />
    $Smtp.Send($Msg)<br />
    }</p>
<p># Function for Exchange Connection<br />
function Connect-Exchange{<br />
    $ADEncryptedBytes = [System.Convert]::FromBase64String($ADEncryptedPwd)<br />
    $ADDecryptedBytes = $Cert.PrivateKey.Decrypt($ADEncryptedBytes, $true)<br />
    $ADDecryptedPwd = [system.text.encoding]::UTF8.GetString($ADDecryptedBytes) | ConvertTo-SecureString -AsPlainText -Force<br />
    $ADCredentials = New-Object System.Management.Automation.PSCredential ($ADUsername,$ADDecryptedPwd)<br />
    $ExchSession = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri http://$ExchangeServer/PowerShell/ -Authentication Kerberos -Credential $ADCredentials<br />
    Import-PSSession $ExchSession<br />
    } </p>
<p># Function for MSOL Connection<br />
function Connect-MSOL{<br />
    $MSOLEncryptedBytes = [System.Convert]::FromBase64String($MSOLEncryptedPwd)<br />
    $MSOLDecryptedBytes = $Cert.PrivateKey.Decrypt($MSOLEncryptedBytes, $true)<br />
    $MSOLDecryptedPwd = [system.text.encoding]::UTF8.GetString($MSOLDecryptedBytes) | ConvertTo-SecureString -AsPlainText -Force<br />
    $MSOLCredentials = New-Object System.Management.Automation.PSCredential ($MSOLUsername,$MSOLDecryptedPwd)<br />
    Connect-MSOLService -Credential $MSOLCredentials<br />
    }<br />
[/powershell]</p>
<p>Next we have the &lsquo;licensing phase&rsquo; &ndash; This phase also generates the email report because a user is considered to be fully provisioned once they have a license assigned. We can also catch any errors and generate an error report email for those.</p>
<p>[powershell]<br />
# Licensing Phase - Check if any users need to have licenses assigned<br />
$NeedLicense = Get-AdGroupMember -Identity O365_License<br />
If ($NeedLicense) {<br />
        $HasMbxArray = @()<br />
        Connect-MSOL<br />
        Foreach ($User in $NeedLicense) {<br />
            $UserInfo = Get-ADUser $User.SamAccountName -Properties *<br />
            $Username = $UserInfo.SamAccountName<br />
            $UserEmail = $UserInfo.Mail<br />
            $UserLic = $UserInfo.extensionAttribute1<br />
            $UserLoc = $UserInfo.c<br />
            $UPN = $UserInfo.UserPrincipalName<br />
            $MsolUser = Get-MsolUser -UserPrincipalName $UPN<br />
            $HasLic = $MsolUser.IsLicensed<br />
                If ($MsolUser -and $UserLic -and $UserLoc) {<br />
                    Try {<br />
						If ($HasLic) {<br />
	                    $ExistingLic = $MsolUser.Licenses.AccountSkuId<br />
	                    Set-MsolUserLicense -UserPrincipalName $UPN -RemoveLicenses $ExistingLic<br />
	                    }<br />
	                    If ($UserLic -eq 'Exchange 2') {<br />
	                    Set-MsolUser -UserPrincipalName $UPN -UsageLocation $UserLoc<br />
	                    Set-MsolUserLicense -UserPrincipalName $UPN -AddLicenses $EP2SKU<br />
                            Remove-AdGroupMember -Identity O365_License -Members $Username -Confirm:$False<br />
	                    }<br />
	                    ElseIf ($UserLic -eq 'E3') {<br />
	                    Set-MsolUser -UserPrincipalName $UPN -UsageLocation $UserLoc<br />
	                    Set-MsolUserLicense -UserPrincipalName $UPN -AddLicenses $E3SKU<br />
                            Remove-AdGroupMember -Identity O365_License -Members $Username -Confirm:$False<br />
                       }<br />
					 }<br />
					Catch {<br />
        			$EmailSubject = 'Office 365 Provisioning Error'<br />
        			$EmailBody = @"<br />
<html><br />
<head><br />
</head><br />
<body></p>
<p>Hello,</p>
<p>This is an automated report from the Office 365 Provisioning Service. The following errors occurred when attempting to provision users in Office 365:</p>
<p><span style="color:#B22222;">$Error</span></p>
<p><strong>Additional Diagnostic Info:</strong><br />
Username: $Username<br />
Email Address: $UserEmail<br />
License Assigned: $UserLic<br />
Usage Location: $UserLoc</p>
<p>Regards,
<p>Provisioning Service</p>
<p></body><br />
</html><br />
"@<br />
			        Send-Report<br />
			        }<br />
                    $EmailBody += '<br />
<tr>'<br />
	            $EmailBody += "
<td>$Username</td>
<p>"<br />
	            $EmailBody += "
<td>$UserEmail</td>
<p>"<br />
	            $EmailBody += "
<td>$UserLic</td>
<p>"<br />
	            $EmailBody += '</tr>
<p>'<br />
                      }<br />
                     }<br />
	        $Licenses = Get-MsolAccountSku<br />
	        $E3Consumed = $Licenses[0].ConsumedUnits<br />
	        $E3Total = $Licenses[0].ActiveUnits<br />
	        $E3Remaining = $E3Total - $E3Consumed<br />
	        $ExP2Consumed = $Licenses[1].ConsumedUnits<br />
	        $ExP2Total = $Licenses[1].ActiveUnits<br />
	        $ExP2Remaining = $ExP2Total - $ExP2Consumed<br />
	        $EmailBodyLic = @"<br />
	</tbody>
</table>
<p><strong>License Summary:</strong></p>
<ul>
<li>You have consumed <strong>$E3Consumed</strong> Exchange Online (Plan 2) licenses and have <strong>$E3Remaining</strong> remaining</li>
<li>You have consumed <strong>$ExP2Consumed</strong> Office 365 Enterprise E3 licenses and have <strong>$ExP2Remaining</strong> remaining</span></li>
</ul>
<p>"@<br />
	        $EmailSubject = 'Office 365 Provisioning Report'<br />
	        $EmailBody += $EmailBodyLic<br />
	        $EmailBody += $EmailBodyClosure<br />
	        Send-Report<br />
    }<br />
[/powershell]</p>
<p>The &lsquo;mailbox enablement phase&rsquo; connects to the local Exchange server and creates a new remote mailbox. <a href="http://www.cgoosen.com/2016/01/how-to-create-a-remote-office-365-mailbox-in-a-hybrid-deployment/" target="_blank">See this post for more information</a> on this process. This phase also attempts to generate error notification emails.</p>
<p>[powershell]<br />
# Mailbox Enablement Phase - Check if any new mailboxes need to be provisioned<br />
$NeedMailbox = Get-AdGroupMember -Identity O365_Provisioning<br />
If ($NeedMailbox) {<br />
    Connect-Exchange<br />
    Foreach ($User in $NeedMailbox) {<br />
    $Username = $User.SamAccountName<br />
    $UserInfo = Get-ADUser $Username -Properties *<br />
    $UserLic = $UserInfo.extensionAttribute1<br />
    $UserLoc = $UserInfo.c<br />
    If ($UserLic -and $UserLoc){<br />
        Try {<br />
            Enable-RemoteMailbox $Username -RemoteRoutingAddress "$Username@$RoutingDomain"<br />
            Add-ADGroupMember -Identity O365_License -Members $Username<br />
            Remove-AdGroupMember -Identity O365_Provisioning -Members $Username -Confirm:$False<br />
                }<br />
        Catch {<br />
        $EmailSubject = 'Office 365 Provisioning Error'<br />
        $EmailBody = @"<br />
<html><br />
<head><br />
</head><br />
<body></p>
<p>Hello,</p>
<p>This is an automated report from the Office 365 Provisioning Service. The following errors occurred when attempting to mail-enable users:</p>
<p><span style="color:#B22222;">$Error</span></p>
<p><strong>Additional Diagnostic Info:</strong><br />
Username: $Username</p>
<p>Regards,
<p>Provisioning Service</p>
<p></body><br />
</html><br />
"@<br />
        Send-Report<br />
        }<br />
        }<br />
    Else {<br />
        $EmailSubject = 'Office 365 Provisioning Error'<br />
        $EmailBody = @"<br />
<html><br />
<head><br />
</head><br />
<body></p>
<p>Hello,</p>
<p>This is an automated report from the Office 365 Provisioning Service. The following user could not be provisioned, please check to ensure that the required license type has been correctly entered in the "Company" field and that the "Country/region" has been set:</p>
<p><span style="color:#B22222;">User: $Username</span></p>
<p>Regards,
<p>Provisioning Service</p>
<p></body><br />
</html><br />
"@<br />
        Send-Report<br />
        }<br />
    }<br />
}<br />
[/powershell]</p>
<p>Putting this all together will hopefully form be a great foundation to help you build your own workflow. Once done, you can simply schedule your script to run using task scheduler.</p>


        
    </div>

    <footer class="post-footer">
        <div class="share">Share
            <ul class="social-networks">
                <li class="share-facebook"><a href="https://www.facebook.com/sharer.php?s=100&p[title]=Using PowerShell to automate Office 365 license assignment&p[summary]=The move to Office 365 almost always requires changes to existing operational processes. One of the processes that inevitably requires an...&p[url]=http://172.16.7.177:4000/2016/03/using-powershell-to-automate-office-365-license-assignment" class="s_facebook" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#facebook-icon"></use></svg></a></a></li>
                <li class="share-twitter"><a href="http://twitter.com/share?url=http://172.16.7.177:4000/2016/03/using-powershell-to-automate-office-365-license-assignment&text=The move to Office 365 almost always requires changes to existing operational processes. One of the processes that inevitably requires an...&hashtags=" rel="noreferrer" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#twitter-icon"></use></svg></a></li>
            </ul>
        </div>
        
        <div class="tags">
            <ul>
                
            </ul>
        </div>
        
    </footer>
</article>

<article class="post" role="article" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="post-header">
        <ul>
            <li><time datetime="2015-10-29T10:34:43-05:00" itemprop="datePublished">29 Oct, 2015</time></li>
            
        </ul>
        <h2 itemprop="name headline"><a href="http://172.16.7.177:4000/2015/10/my-connect-exo-ps1-script-has-been-updated">My Connect-EXO.ps1 script has been updated!</a></h2>
    </header>

    <div class="post-content">
        <p>I recently published an updated version of my Connect-EXO.ps1 script. Version 3.0 includes the option to connect to Azure AD. Based on the options selected it will connect to either or both services, here is a screenshot of the new interface:</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2015/10/Capture.png"><img title="Capture" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="Capture" src="http://www.cgoosen.com/wp-content/uploads/2015/10/Capture_thumb.png" width="507" height="336"></a></p>
<p>The update has been published to the TechNet Gallery, <a href="http://cgoo.se/1srvTiS">it can be downloaded by clicking here&hellip;</a></p>


        
    </div>

    <footer class="post-footer">
        <div class="share">Share
            <ul class="social-networks">
                <li class="share-facebook"><a href="https://www.facebook.com/sharer.php?s=100&p[title]=My Connect-EXO.ps1 script has been updated!&p[summary]=I recently published an updated version of my Connect-EXO.ps1 script. Version 3.0 includes the option to connect to Azure AD. Based on th...&p[url]=http://172.16.7.177:4000/2015/10/my-connect-exo-ps1-script-has-been-updated" class="s_facebook" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#facebook-icon"></use></svg></a></a></li>
                <li class="share-twitter"><a href="http://twitter.com/share?url=http://172.16.7.177:4000/2015/10/my-connect-exo-ps1-script-has-been-updated&text=I recently published an updated version of my Connect-EXO.ps1 script. Version 3.0 includes the option to connect to Azure AD. Based on th...&hashtags=" rel="noreferrer" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#twitter-icon"></use></svg></a></li>
            </ul>
        </div>
        
        <div class="tags">
            <ul>
                
            </ul>
        </div>
        
    </footer>
</article>

<article class="post" role="article" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="post-header">
        <ul>
            <li><time datetime="2015-04-29T05:50:10-05:00" itemprop="datePublished">29 Apr, 2015</time></li>
            
        </ul>
        <h2 itemprop="name headline"><a href="http://172.16.7.177:4000/2015/04/user-powershell-to-bulk-email-your-users">Using PowerShell to bulk email your users</a></h2>
    </header>

    <div class="post-content">
        <p>I was recently working on a migration project with a customer and volunteered to help find a solution to a challenge the Organizational Change Management (OCM) team were facing. The OCM team had been communicating with the business to keep them informed about the upcoming changes and what impact these changes would have on their day to day operations. This communication had all taken place via email and they now needed to send out a new notification to several thousand users that contained specific information that would be different for each recipient. Since this was a single-use scenario and all recipients were internal users, they were not terribly interested in investing in a third-party application or service to do this so we decided to explore other options.</p>
<p><a href="http://www.ehloworld.com/175" target="_blank">Inspired by Pat Richard&rsquo;s &ldquo;New-WelcomeEmail.ps1&rdquo; script</a>, I figured it would be pretty easy to achieve this using a PowerShell script and .CSV input file, it works great! To illustrate this, I&rsquo;ll use the fictitious example of gooseLabs, Inc who are relocating to a new office building and would like to send a notification email to all their users that contains their new desk location and phone number. The first and most important step is to ensure that you have an accurate input file. For this particular scenario, the input file looks something like this:</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2015/04/1.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="1" src="http://www.cgoosen.com/wp-content/uploads/2015/04/1_thumb.png" alt="1" width="453" height="364" border="0" /></a></p>
<p align="left">Once we have our input file created, we can use the magic of PowerShell to generate our notifications using this data. The following script imports the .CSV file and generates a simple email notification that is then sent to everyone in the list:</p>
<p>[powershell]<br />
# Function to create report email<br />
function SendNotification{<br />
 $Msg = New-Object Net.Mail.MailMessage<br />
 $Smtp = New-Object Net.Mail.SmtpClient($ExchangeServer)<br />
 $Msg.From = $FromAddress<br />
 $Msg.To.Add($ToAddress)<br />
 $Msg.Subject = "Announcement: Important information about your office relocation."<br />
 $Msg.Body = $EmailBody<br />
 $Msg.IsBodyHTML = $true<br />
 $Smtp.Send($Msg)<br />
}</p>
<p># Define local Exchange server info for message relay. Ensure that any servers running this script have permission to relay.<br />
$ExchangeServer = "yourexchange.domain.com"<br />
$FromAddress = "Office Relocation Team <relocation@domain.com>"</p>
<p># Import user list and information from .CSV file<br />
$Users = Import-Csv UserList.csv</p>
<p># Send notification to each user in the list<br />
Foreach ($User in $Users) {<br />
 $ToAddress = $User.Email<br />
 $Name = $User.FirstName<br />
 $Level = $User.Level<br />
 $DeskNum = $User.DeskNumber<br />
 $PhoneNum = $User.PhoneNumber<br />
 $EmailBody = @"<br />
 <html><br />
 <head><br />
 </head><br />
 <body></p>
<p>Dear $Name,</p>
<p>As you know we will be relocating to our new offices at 742 Evergreen Terrace, Springfield on July 1, 2015. This email contains important information to help you get settled as quickly as possible.</p>
<p>Your existing access card will grant you access to the new building and your desk location is as follows:</p>
<p><strong>Level:</strong> $Level<br />
 <strong>Desk Number:</strong> $DeskNum<br />
 <strong>Phone Number:</strong> $PhoneNum</p>
<p>Your new phone will be connected and ready for use when you arrive.</p>
<p>If you require any assistance during the move please contact the relocation helpdesk at relocation@gooselabs.net or by calling 555-555-1234</p>
<p>Regards,</p>
<p>Office Relocation Team</p>
<p> </body><br />
 </html><br />
"@<br />
 Write-Host "Sending notification to $Name ($ToAddress)" -ForegroundColor Yellow<br />
 SendNotification<br />
}<br />
[/powershell]</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2015/04/2.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="2" src="http://www.cgoosen.com/wp-content/uploads/2015/04/2_thumb.png" alt="2" width="500" height="369" border="0" /></a></p>
<p align="left">The resulting notification looks like this:</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2015/04/3.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="3" src="http://www.cgoosen.com/wp-content/uploads/2015/04/3_thumb.png" alt="3" width="600" height="238" border="0" /></a></p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2015/04/4.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="4" src="http://www.cgoosen.com/wp-content/uploads/2015/04/4_thumb.png" alt="4" width="600" height="238" border="0" /></a></p>
<p align="left">This method could also be used to distribute other information, like temporary passwords prior to a <a href="https://technet.microsoft.com/en-us/library/jj898490%28v=exchg.150%29.aspx" target="_blank">Cutover Exchange Migration.</a></p>


        
    </div>

    <footer class="post-footer">
        <div class="share">Share
            <ul class="social-networks">
                <li class="share-facebook"><a href="https://www.facebook.com/sharer.php?s=100&p[title]=Using PowerShell to bulk email your users&p[summary]=I was recently working on a migration project with a customer and volunteered to help find a solution to a challenge the Organizational C...&p[url]=http://172.16.7.177:4000/2015/04/user-powershell-to-bulk-email-your-users" class="s_facebook" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#facebook-icon"></use></svg></a></a></li>
                <li class="share-twitter"><a href="http://twitter.com/share?url=http://172.16.7.177:4000/2015/04/user-powershell-to-bulk-email-your-users&text=I was recently working on a migration project with a customer and volunteered to help find a solution to a challenge the Organizational C...&hashtags=" rel="noreferrer" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#twitter-icon"></use></svg></a></li>
            </ul>
        </div>
        
        <div class="tags">
            <ul>
                
            </ul>
        </div>
        
    </footer>
</article>

<article class="post" role="article" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="post-header">
        <ul>
            <li><time datetime="2015-02-24T03:00:00-06:00" itemprop="datePublished">24 Feb, 2015</time></li>
            
        </ul>
        <h2 itemprop="name headline"><a href="http://172.16.7.177:4000/2015/02/using-a-certificate-to-encrypt-credentials-in-automated-powershell-scripts">Using a certificate to encrypt credentials in automated PowerShell scripts</a></h2>
    </header>

    <div class="post-content">
        <p>PowerShell is a great way to help automate frequent or repetitive tasks and every now and then these tasks require some form of authentication. You could just store the service account password in the script, but I&rsquo;m really not a fan of doing that and I&rsquo;m sure you&rsquo;d agree it really isn&rsquo;t a very good way to do it. I was working on a script recently which was to be scheduled to run at various times by different service accounts on different servers so I wanted a way to ensure that a single copy of the script could be portable to any server and would still securely connect to Exchange with the correct permissions no matter which service account actually executed the script. Remotely connecting to Exchange/Exchange Online via PowerShell isn&rsquo;t difficult to do and you could just use <em>Get-Credential</em> cmdlet with <em>ConvertFrom-SecureString</em> and <em>Set-Content </em>to securely save your password to file which could then be read by your script without subsequent intervention. The trouble with this solution is that it isn&rsquo;t very portable and that password can only be ready by the user that created the file so it will work great if you used it only on your own machine, but not so well when trying to distribute it to a bunch of servers as a scheduled job. I wanted a solution that would use a particular certificate to decrypt a password stored in the script, in that way if the script was executed on a machine that did not have my certificate installed it would not be able to decrypt the password and would fail. I ended up creating an encrypted password using the public key of a certificate and storing that in the script, the only way to decrypt that password is with the private key of the same certificate. Let&rsquo;s look at this in more detail.</p>
<p>The first component of the solution is a certificate. Since I already had access to a internal Windows CA, I wanted to use a certificate signed by that CA but I also tested it with a self-signed certificate that was generated using &ldquo;makecert.exe&rdquo;. <span style="background-color: #ffffff;">PowerShell 4.0 </span>includes a <a href="https://technet.microsoft.com/en-us/library/hh848633.aspx" target="_blank"><em>New-SelfSignedCertificate</em></a> cmdlet that makes generating a self-signed certificate really easy, but for some reason I wasn&rsquo;t able to use one of those certificates for encryption (more specifically the decryption would not work) and since I planned to use a CA signed certificate anyway I didn&rsquo;t spend a whole lot of time trying to figure it out. The key thing to remember is that you need to install the certificate AND the private key, the certificate doesn&rsquo;t have to be trusted. I decided to create a new certificate template for my &ldquo;Script Authentication&rdquo; certificate by duplicating the &ldquo;Web Server&rdquo; template and making a few changes to it.</p>
<p align="left">Firstly, launch the <span style="background-color: #ffffff;">Certification Authority MMC</span><span style="background-color: #ffffff;">, loca</span>te &ldquo;Certificate Templates&rdquo;, right-click and select &ldquo;Manage&rdquo;</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture1.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="Capture1" src="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture1_thumb.png" alt="Capture1" width="450" height="294" border="0" /></a></p>
<p>Next, locate the &ldquo;Web Server&rdquo; template, right-click and select &ldquo;Duplicate Template&rdquo;</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture2.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="Capture2" src="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture2_thumb.png" alt="Capture2" width="450" height="169" border="0" /></a></p>
<p align="left">I called my new template &ldquo;Script Authentication&rdquo;</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture3.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="Capture3" src="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture3_thumb.png" alt="Capture3" width="504" height="686" border="0" /></a></p>
<p align="left">And you need to ensure that you &ldquo;Allow private key to be exported&rdquo;. Once done, apply those changes.</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture4.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="Capture4" src="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture4_thumb.png" alt="Capture4" width="504" height="686" border="0" /></a></p>
<p align="left">We then need to <span style="background-color: #ffffff;">publish the new template</span> to ensure that it can be used when requesting a new certificate. <span style="background-color: #ffffff;">Right-click</span> &ldquo;Certificate Templates&rdquo;, select &ldquo;New&rdquo; and then &ldquo;Certificate Template to Issue&rdquo; and select your newly created template from the list</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture5.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="Capture5" src="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture5_thumb.png" alt="Capture5" width="550" height="353" border="0" /></a></p>
<p align="left">Once done, you should be able to create and submit an advanced certificate request using the newly created template directly on your CA. You are not required to complete all the fields, but it is useful to give your certificate a descriptive name. I called mine &ldquo;PowerShell Automation&rdquo;.</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture6.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="Capture6" src="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture6_thumb.png" alt="Capture6" width="550" height="810" border="0" /></a></p>
<p>Once you have the installed the certificate, you can export it (don&rsquo;t forget the private key) for use on other machines.</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture8.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="Capture8" src="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture8_thumb.png" alt="Capture8" width="550" height="529" border="0" /></a></p>
<p>I recommend storing it in a safe place and not marking the private key as exportable when moving it around, in this way you have some control over which machines can actually decrypt the password in your script.</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture9.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="Capture9" src="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture9_thumb.png" alt="Capture9" width="550" height="529" border="0" /></a></p>
<p>Here&rsquo;s what my certificate looks like</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture7.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="Capture7" src="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture7_thumb.png" alt="Capture7" width="500" height="622" border="0" /></a></p>
<p>I decided to store my certificate in the computer store, it probably doesn&rsquo;t matter where you store it but you would need to update the following PowerShell cmdlets appropriately. If you are going to have multiple service accounts executing your script, you need to ensure that all these accounts have permission<span style="background-color: #ffff00;"><span style="background-color: #ffffff;"> to read the private key. </span></span><span style="background-color: #ffffff;">This</span> is done by right-clicking the certificate, selecting &ldquo;All Tasks&rdquo; and then &ldquo;Manage Private Keys&rdquo;.</p>
<p>We can use the <em>Get-ChildItem</em> cmdlet to locate our certificate:</p>
<p>[powershell]Get-ChildItem Cert:\LocalMachine\My | Where-Object {$_.Subject -like "CN=PowerShell Automation*"}[/powershell]</p>
<p>Next, I need to encrypt my password. To do this, I define the password as a variable, encode it and then encrypt the encoded password using my certificate&rsquo;s public key:</p>
<p>[powershell]<br />
$Cert = Get-ChildItem Cert:\LocalMachine\My | Where-Object {$_.Subject -like "CN=PowerShell Automation*"}<br />
$Password = 'MyPassword'<br />
$EncodedPwd = [system.text.encoding]::UTF8.GetBytes($Password)<br />
$EncryptedBytes = $Cert.PublicKey.Key.Encrypt($EncodedPwd, $true)<br />
$EncryptedPwd = [System.Convert]::ToBase64String($EncryptedBytes)<br />
[/powershell]</p>
<p><a href="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture10.png"><img style="background-image: none; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; margin-right: auto; border: 0px;" title="Capture10" src="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture10_thumb.png" alt="Capture10" width="550" height="195" border="0" /></a></p>
<p>Now that I have the encrypted password, I can store it in my script and decode it using my certificate&rsquo;s private key each time the script is executed. To do this, I pretty much reverse the process:</p>
<p>[powershell]<br />
$EncryptedPwd = "ts32rCLLdZl3/6wINHtLD6bQO65ub&hellip;.. <shortened for simplicity>"<br />
$EncryptedBytes = [System.Convert]::FromBase64String($EncryptedPwd)<br />
$DecryptedBytes = $Cert.PrivateKey.Decrypt($EncryptedBytes, $true)<br />
$DecryptedPwd = [system.text.encoding]::UTF8.GetString($DecryptedBytes)<br />
[/powershell]</p>
<p>You can build this into any scripts you have that currently require credentials, it works great for automating Office 365/Exchange Online scripting. To illustrate this, I put together a quick (and dirty!) script that can be used to provide an automated daily &ldquo;Top Mail Recipient&rdquo; report via email. This script can be scheduled to run daily and it will connect to Exchange Online, generate a list of the top mail recipients and email that report to the address you specify. It&rsquo;s not very useful as it is, but it does show how easily you could automate things using PowerShell and serves as a great example for certificate password encryption.</p>
<p>[powershell]<br />
# Function to create report email<br />
function SendReport{<br />
 $Msg = New-Object Net.Mail.MailMessage<br />
 $Smtp = New-Object Net.Mail.SmtpClient($ExchangeServer)<br />
 $Msg.From = $FromAddress<br />
 $Msg.To.Add($ToAddress)<br />
 $Msg.Subject = "Top Mail Recipient Report for $Date"<br />
 $Msg.Body = $EmailBody<br />
 $Msg.IsBodyHTML = $true<br />
 $Smtp.Send($Msg)<br />
}</p>
<p># Define local Exchange server info for message relay. Ensure that any servers running this script have permission to relay.<br />
$ExchangeServer = "yourexchange.domain.com"<br />
$FromAddress = "Office 365 Reports <reports@yourdomain.com>"<br />
$ToAddress = "you@yourdomain.com"</p>
<p># Some basic HTML styling<br />
$Header = "<br />
<style>"<br />
$Header = $Header + "BODY{background-color:#FFFFFF}"<br />
$Header = $Header + "TABLE{border-width: 1px;border-style: solid;border-color: black;border-collapse: collapse;}"<br />
$Header = $Header + "TH{border-width: 1px;padding: 0px;border-style: solid;border-color: black;background-color:#BDBDBD}"<br />
$Header = $Header + "TD{border-width: 1px;padding: 0px;border-style: solid;border-color: black}"<br />
$Header = $Header + "</style>
<p>"</p>
<p># Connect to Exchange Online<br />
# First decrypt the password using the certificate<br />
$Cert = Get-ChildItem Cert:\LocalMachine\My | Where-Object {$_.Subject -like "CN=PowerShell Automation*"}<br />
$EncryptedPwd = "ts32rCLLdZl3/6wINHtLD6bQO65ubeQ3sHj9zXbhsaQDjihQmdyoja+iL0NGXQX0DicQdXWQRu+P8dSy96ux1tLQR9ZT8WPRq8rHsR3gNXDmipCK/4CHoc5Ki7nbMKUSReprtIrnwjlXZNBocTzurBQ+LtAHvAYipD37AXVjjpwwwqud5HCXk+E4OrJGe+yIx/87neRAunqdKvyuaxUYaxeBdx2R/hpLZhxywinjjVMx+0N2RNk7H3fBEite7uuANcAg+ElAssi4DAQYYDOviIrvbjdpKogKcevAh5xEx4Wm2WBzM5XqXmj1O9TUzB9BOiUVQhDwwqCcUpb2bTNW7g=="<br />
$EncryptedBytes = [System.Convert]::FromBase64String($EncryptedPwd)<br />
$DecryptedBytes = $Cert.PrivateKey.Decrypt($EncryptedBytes, $true)<br />
$DecryptedPwd = [system.text.encoding]::UTF8.GetString($DecryptedBytes) | ConvertTo-SecureString -AsPlainText -Force<br />
# Then define Credentials and create session<br />
$Username = "account@yourdomain.onmicrosoft.com"<br />
$Credential = New-Object System.Management.Automation.PSCredential ($Username,$DecryptedPwd)<br />
$Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $Credential -Authentication Basic -AllowRedirection<br />
Import-PSSession $Session</p>
<p># Generate report data<br />
$Date = Get-Date -DisplayHint Date<br />
$EmailBody = Get-MailTrafficSummaryReport -Category TopMailRecipient | select @{expression={$_.C1};label=&rdquo;User&rdquo;}, @{expression={$_.C2};label=&rdquo;Item Count&rdquo;} | ConvertTo-HTML -head $Header -body "<H2>Top Mail Recipient Report</H2>"</p>
<p># Send report<br />
SendReport<br />
[/powershell]</p>
<p>Here is an example of what the final result looks like:</p>
<p align="center"><a href="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture11.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="Capture11" src="http://www.cgoosen.com/wp-content/uploads/2015/02/Capture11_thumb.png" alt="Capture11" width="600" height="448" border="0" /></a></p>


        
    </div>

    <footer class="post-footer">
        <div class="share">Share
            <ul class="social-networks">
                <li class="share-facebook"><a href="https://www.facebook.com/sharer.php?s=100&p[title]=Using a certificate to encrypt credentials in automated PowerShell scripts&p[summary]=PowerShell is a great way to help automate frequent or repetitive tasks and every now and then these tasks require some form of authentic...&p[url]=http://172.16.7.177:4000/2015/02/using-a-certificate-to-encrypt-credentials-in-automated-powershell-scripts" class="s_facebook" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#facebook-icon"></use></svg></a></a></li>
                <li class="share-twitter"><a href="http://twitter.com/share?url=http://172.16.7.177:4000/2015/02/using-a-certificate-to-encrypt-credentials-in-automated-powershell-scripts&text=PowerShell is a great way to help automate frequent or repetitive tasks and every now and then these tasks require some form of authentic...&hashtags=" rel="noreferrer" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://172.16.7.177:4000/assets/svg/social-icons.svg#twitter-icon"></use></svg></a></li>
            </ul>
        </div>
        
        <div class="tags">
            <ul>
                
            </ul>
        </div>
        
    </footer>
</article>

            </main>
        </div>

        <script src="http://172.16.7.177:4000/assets/js/jquery-1.12.2.min.js"></script>
<script src="http://172.16.7.177:4000/assets/js/backtotop.js"></script>
<script src="http://172.16.7.177:4000/assets/js/lunr.min.js"></script>
<script src="http://172.16.7.177:4000/assets/js/lunr-feed.js"></script>
<script src="http://172.16.7.177:4000/assets/js/jquery.fitvids.js"></script>
<script src="http://172.16.7.177:4000/assets/js/svg4everybody.min.js"></script>
<script src="http://172.16.7.177:4000/assets/js/scripts.js"></script>


    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-XXXXXXX-2', 'auto');
        ga('send', 'pageview');
    </script>

        <style>
.lightbox {width: 100%; height: 100%; position: fixed; top: 0; left: 0; background: rgba(0,0,0,0.85); z-index: 9999999; line-height: 0; cursor: pointer;}
.lightbox .img {
	position: relative; 
	top: 50%;
	left: 50%;
	-ms-transform: translateX(-50%) translateY(-50%);
	-webkit-transform: translate(-50%,-50%);
	transform: translate(-50%,-50%);
	max-width: 100%;
	max-height: 100%;
}
.lightbox .img img {opacity: 0; pointer-events: none; width: auto;}
@media screen and (min-width: 1200px) {
    .lightbox .img {
		max-width: 1200px;
    }
}
@media screen and (min-height: 1200px) {
    .lightbox img {
		max-height: 1200px;
	}
}
.lightbox span {display: block; position: fixed; bottom: 13px; height: 1.5em; line-height: 1.4em; width: 100%; text-align: center; color: white; text-shadow:
    -1px -1px 0 #000,
    1px -1px 0 #000,
    -1px 1px 0 #000,
    1px 1px 0 #000;  
}






.lightbox .videoWrapperContainer {
	position: relative; 
	top: 50%;
	left: 50%;
	-ms-transform: translateX(-50%) translateY(-50%);
	-webkit-transform: translate(-50%,-50%);
	transform: translate(-50%,-50%);
	max-width: 900px;
	max-height: 100%;
}
.lightbox .videoWrapperContainer .videoWrapper {
	height: 0;
	line-height: 0;
	margin: 0;
	padding: 0;
	position: relative;
	padding-bottom: 56.333%; /* custom */
	background: black;
} 
.lightbox .videoWrapper iframe {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	border: 0;
	display: block;
}   
.lightbox #prev, .lightbox #next {height: 50px; line-height: 36px; display: none; margin-top: -25px; position: fixed; top: 50%; padding: 0 15px; cursor: pointer; text-decoration: none; z-index: 99; color: white; font-size: 60px;}
.lightbox.gallery #prev, .lightbox.gallery #next {display: block;}
.lightbox #prev {left: 0;}
.lightbox #next {right: 0;}
.lightbox #close {height: 50px; width: 50px; position: fixed; cursor: pointer; text-decoration: none; z-index: 99; right: 0; top: 0;}
.lightbox #close:after, .lightbox #close:before {position: absolute; margin-top: 22px; margin-left: 14px; content: ""; height: 3px; background: white; width: 23px;
-webkit-transform-origin: 50% 50%;
-moz-transform-origin: 50% 50%;
-o-transform-origin: 50% 50%;
transform-origin: 50% 50%;
/* Safari */
-webkit-transform: rotate(-45deg);
/* Firefox */
-moz-transform: rotate(-45deg);
/* IE */
-ms-transform: rotate(-45deg);
/* Opera */
-o-transform: rotate(-45deg);
}
.lightbox #close:after {
/* Safari */
-webkit-transform: rotate(45deg);
/* Firefox */
-moz-transform: rotate(45deg);
/* IE */
-ms-transform: rotate(45deg);
/* Opera */
-o-transform: rotate(45deg);
}
.lightbox, .lightbox * {
    -webkit-user-select: none;  
    -moz-user-select: none;    
    -ms-user-select: none;      
    user-select: none;
}
</style>
		
<script>
function is_youtubelink(url) {
  var p = /^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;
  return (url.match(p)) ? RegExp.$1 : false;
}
function is_imagelink(url) {
	var p = /([a-z\-_0-9\/\:\.]*\.(jpg|jpeg|png|gif))/i;
	return (url.match(p)) ? true : false;
}
function is_vimeolink(url,el) {
	var id = false;
	$.ajax({
	  url: 'https://vimeo.com/api/oembed.json?url='+url,
	  async: true,
	  success: function(response) {
		if(response.video_id) {
		  id = response.video_id;
		  $(el).addClass('lightbox-vimeo').attr('data-id',id);
		}
	  }
	});
}

$(document).ready(function() {
	//add classes to links to be able to initiate lightboxes
	$("a").each(function(){
		var url = $(this).attr('href');
		if(url) {
			if(url.indexOf('vimeo') !== -1 && !$(this).hasClass('no-lightbox')) is_vimeolink(url,$(this));
			if(is_youtubelink(url) && !$(this).hasClass('no-lightbox')) $(this).addClass('lightbox-youtube').attr('data-id',is_youtubelink(url));
			if(is_imagelink(url) && !$(this).hasClass('no-lightbox')) {
				$(this).addClass('lightbox-image');
				var href = $(this).attr('href');
				var filename = href.split('/').pop();
				var split = filename.split(".");
				var name = split[0];
				$(this).attr('title',name);
			}
		}
	});
	//remove the clicked lightbox
	$("body").on("click", ".lightbox", function(event){
		if($(this).hasClass('gallery')) {
			$(this).remove();
			if($(event.target).attr('id')=='next') {
				//next item
				if($("a.gallery.current").nextAll("a.gallery:first").length) $("a.gallery.current").nextAll("a.gallery:first").click();
				else $("a.gallery.current").parent().find("a.gallery").first().click();
			}
			else if ($(event.target).attr('id')=='prev') {
				//prev item
				if($("a.gallery.current").prevAll("a.gallery:first").length) $("a.gallery.current").prevAll("a.gallery:first").click();
				else $("a.gallery.current").parent().find("a.gallery").last().click();
			}
			else {
				$("a.gallery").removeClass('gallery');
			}
		}
		else $(this).remove();
	});
	//prevent image from being draggable (for swipe)
	$("body").on('dragstart', ".lightbox img", function(event) { event.preventDefault(); });
	//add the youtube lightbox on click
	$("a.lightbox-youtube").click(function(event){
		event.preventDefault();
		$('<div class="lightbox"><a id="close"></a><a id="next">&rsaquo;</a><a id="prev">&lsaquo;</a><div class="videoWrapperContainer"><div class="videoWrapper"><iframe src="https://www.youtube.com/embed/'+$(this).attr('data-id')+'?autoplay=1&showinfo=0&rel=0"></iframe></div></div></div>').appendTo('body');
	});
	//add the image lightbox on click
	$("a.lightbox-image").click(function(event){
		event.preventDefault();
		$('<div class="lightbox"><a id="close"></a><a id="next">&rsaquo;</a><a id="prev">&lsaquo;</a><div class="img" style="background: url('+$(this).attr('href')+') center center / contain no-repeat;" title="'+$(this).attr('title')+'" ><img src="'+$(this).attr('href')+'" alt="'+$(this).attr('title')+'" /></div><span>'+$(this).attr('title')+'</span></div>').appendTo('body');
	});
	//add the vimeo lightbox on click
	$("body").on("click", "a.lightbox-vimeo", function(event){
		event.preventDefault();
		$('<div class="lightbox"><a id="close"></a><a id="next">&rsaquo;</a><a id="prev">&lsaquo;</a><div class="videoWrapperContainer"><div class="videoWrapper"><iframe src="https://player.vimeo.com/video/'+$(this).attr('data-id')+'/?autoplay=1&byline=0&title=0&portrait=0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div></div></div>').appendTo('body');
	});

	$("body").on("click", "a[class*='lightbox-']", function(){
		var link_elements = $(this).parent().find("a[class*='lightbox-']");
		$(link_elements).removeClass('current');
		for (var i=0; i<link_elements.length; i++) {
			if($(this).attr('href') == $(link_elements[i]).attr('href')) {
				$(link_elements[i]).addClass('current');
			}
		}
		if(link_elements.length>1) {
			$('.lightbox').addClass('gallery');
			$(link_elements).addClass('gallery');
		}
	});

	
});

$(document).keydown(function(e) {
    switch(e.which) {
        case 37: // left
        $("#prev").click();
        break;
        case 39: // right
        $("#next").click();
        break;
	case 27: // esc
        $("#close").click();
        break;
        default: return; // exit this handler for other keys
    }
    e.preventDefault(); // prevent the default action (scroll / move caret)
});

  /*===========================
  Swipe-it v1.4.1
  An event listener for swiping gestures with vanilla js.
  https://github.com/tri613/swipe-it#readme
 
  @Create 2016/09/22
  @Update 2017/08/11
  @Author Trina Lu
  ===========================*/
  "use strict";var _slicedToArray=function(){function n(n,t){var e=[],i=!0,o=!1,r=void 0;try{for(var u,c=n[Symbol.iterator]();!(i=(u=c.next()).done)&&(e.push(u.value),!t||e.length!==t);i=!0);}catch(n){o=!0,r=n}finally{try{!i&&c.return&&c.return()}finally{if(o)throw r}}return e}return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return n(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();!function(n,t,e){function i(n){function e(){o("touchstart",m,w),o("touchmove",d,w),o("touchend",p,w),E.mouseEvent&&o("mousedown",s,w)}function i(){y=!1,D=!1,A=!1,b=!1,a=!1}function s(n){a=this,y=n.clientX,D=n.clientY,o("mousemove",l,v),o("mouseup",h,v)}function l(n){n.preventDefault(),y&&D&&(A=n.clientX,b=n.clientY)}function h(n){r("mousemove",l,v),r("mouseup",h,v),p(n)}function m(n){a=this,y=n.touches[0].clientX,D=n.touches[0].clientY}function d(n){A=n.touches[0].clientX,b=n.touches[0].clientY}function p(n){if(y&&D&&A&&b){var t=y-A,e=D-b,o=[t,e].map(Math.abs),r=_slicedToArray(o,2),c=r[0],s=r[1],v=E.minDistance;if(c>v){var f=y<A?"swipeRight":"swipeLeft";u(f,a,{distance:t,start:y,end:A})}if(s>v){var l=D>b?"swipeUp":"swipeDown";u(l,a,{distance:e,start:D,end:b})}(c>v||s>v)&&u("swipe",a)}i()}var E=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},w=c(t.querySelectorAll(n)),y=void 0,D=void 0,A=void 0,b=void 0;E.mouseEvent=void 0===E.mouseEvent?f.mouseEvent:E.mouseEvent,E.minDistance=void 0===E.minDistance?f.minDistance:E.minDistance,i(),e(),this.on=function(n,t){return o(n,t,w),this}}function o(n,t,e){s(e).forEach(function(e){return e.addEventListener(n,t)})}function r(n,t,e){s(e).forEach(function(e){return e.removeEventListener(n,t)})}function u(n,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=t.createEvent("Event");o.initEvent(n,!0,!0),o.swipe=i,s(e).forEach(function(n){return n.dispatchEvent(o)})}function c(n){for(var t=[],e=0;e<n.length;e++)t.push(n[e]);return t}function s(n){return Array.isArray(n)?n:[n]}var a=!1,v=[n],f={mouseEvent:!0,minDistance:30};n[e]=i}(window,document,"SwipeIt");

var mySwipeIt = new SwipeIt('body');
mySwipeIt.on('swipeLeft',function(e){
	//check if lightbox is present
	if($('.lightbox').length >  0 ) {
		$("#next").click();
	}
}).on('swipeRight',function(e){
	//check if lightbox is present
	if($('.lightbox').length >  0 ) {
		$("#prev").click();
	}
});
</script>

    </body>
</html>